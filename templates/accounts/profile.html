{% extends 'base.html' %}
{% load friend_tags %}

{% block title %}{{ user.username }} • Instagram Photos{% endblock %}

{% block extra_css %}
<style>
    /* Tinh chỉnh lại .main-content cho phù hợp với trang Profile */
    .main-content {
        flex-direction: column; 
        align-items: center;
        padding-top: 30px;
    }

    .container { width: 100%; max-width: 935px; }

    /* --- PROFILE HEADER --- */
    .profile-header {
        display: flex; margin-bottom: 44px;
        border-bottom: 1px solid var(--border-color); padding-bottom: 44px;
    }

    .header-img-col {
        flex: 0 0 290px; display: flex; justify-content: center; margin-right: 30px;
    }
    
    .avatar-ring {
        width: 150px; height: 150px; border-radius: 50%;
        background: linear-gradient(45deg, #f09433, #e6683c, #dc2743, #cc2366, #bc1888);
        padding: 3px; cursor: pointer;
    }
    
    .avatar-img {
        width: 100%; height: 100%; border-radius: 50%;
        border: 3px solid var(--bg-white); object-fit: cover; background: #eee;
    }

    .header-info-col { flex: 1; display: flex; flex-direction: column; gap: 20px; }

    /* Row 1: User & Buttons */
    .info-row-1 { display: flex; align-items: center; gap: 20px; flex-wrap: wrap; }
    .username-text { font-size: 20px; font-weight: 400; cursor: pointer; }
    .username-text:hover { opacity: 0.7; }

    .btn {
        padding: 7px 16px; border-radius: 8px; font-weight: 600; font-size: 14px;
    }
    .btn-grey { background: var(--btn-grey-bg); color: var(--text-main); }
    .btn-grey:hover { background: var(--btn-grey-hover); }
    
    .btn-blue { background: var(--btn-blue-bg); color: #fff; }
    .btn-blue:hover { background: var(--btn-blue-hover); }

    /* Row 2: Stats */
    .info-row-2 { display: flex; gap: 40px; font-size: 16px; }
    .stat strong { font-weight: 600; }

    /* Row 3: Bio */
    .info-row-3 { font-size: 14px; line-height: 1.5; }
    .fullname { font-weight: 600; display: block; }

    /* --- TABS --- */
    .tabs {
        display: flex; justify-content: center; gap: 60px;
        border-top: 1px solid transparent;
    }
    .tab {
        padding: 15px 0; color: var(--text-grey); font-size: 12px; font-weight: 600;
        letter-spacing: 1px; cursor: pointer; display: flex; align-items: center; gap: 6px;
        border-top: 1px solid transparent; margin-top: -1px;
    }
    .tab.active { color: var(--text-main); border-top: 1px solid var(--text-main); }

    /* --- GALLERY --- */
    .gallery {
        display: grid; grid-template-columns: repeat(3, 1fr); gap: 4px; padding-bottom: 50px;
    }
    .gallery-item {
        position: relative; aspect-ratio: 1/1; background: #efefef; cursor: pointer;
    }
    .gallery-item img {
        width: 100%; height: 100%; object-fit: cover;
    }
    .overlay {
        position: absolute; inset: 0; background: rgba(0,0,0,0.3);
        display: flex; justify-content: center; align-items: center; gap: 20px;
        color: #fff; opacity: 0; transition: 0.2s; font-weight: bold; font-size: 16px;
    }
    .gallery-item:hover .overlay { opacity: 1; }

    /* --- MODAL --- */
    .modal {
        display: none; position: fixed; z-index: 100; left: 0; top: 0;
        width: 100%; height: 100%; background-color: rgba(0,0,0,0.65);
    }
    .modal-content {
        background-color: #fff; margin: 10% auto; border-radius: 12px;
        width: 400px; overflow: hidden; animation: zoomIn 0.2s ease-out;
    }
    .modal-header {
        padding: 12px; text-align: center; border-bottom: 1px solid var(--border-color);
        font-weight: 600; font-size: 16px; position: relative;
    }
    .close-modal {
        position: absolute; right: 15px; top: 10px; font-size: 24px; cursor: pointer;
    }
    .modal-body { padding: 20px; display: flex; flex-direction: column; gap: 12px; }
    .data-row { display: flex; justify-content: space-between; font-size: 14px; }
    .data-label { color: var(--text-grey); }

    @keyframes zoomIn { from{transform:scale(1.05);opacity:0;} to{transform:scale(1);opacity:1;} }

    /* Responsive overrides */
    @media (max-width: 768px) {
        .profile-header { flex-direction: column; align-items: center; text-align: center; gap: 20px; }
        .header-img-col { margin-right: 0; flex: 0 0 auto; }
        .info-row-1 { justify-content: center; }
        .info-row-2 { justify-content: center; gap: 20px; }
        .container { padding: 0 10px; }
    }
</style>
{% endblock %}

{% block content %}
    <div class="container">
        <header class="profile-header">
            <div class="header-img-col">
                <div class="avatar-ring">
                    {% if profile.avatar %}
                        <img src="{{ profile.avatar.url }}" alt="Avatar" class="avatar-img">
                    {% else %}
                        <img src="/avatars/normal.jpg" alt="Default Avatar" class="avatar-img">
                    {% endif %}
                </div>
            </div>                

            <div class="header-info-col">
                <div class="info-row-1">
                    <h2 class="username-text" id="usernameTrigger" title="Click to view info">{{ user.username }}</h2>

                    {% if current_user == user %}
                        <a href="/accounts/edit_profile/" class="btn btn-grey">Edit Profile</a>
                        <button class="btn btn-grey">View Archive</button>
                        <button class="btn btn-grey"><i class="fa-solid fa-gear"></i></button>
                    {% else %}
                        <button class="btn btn-blue">Follow</button>
                        <button class="btn btn-grey">Message</button>
                        <button class="btn btn-grey"><i class="fa-solid fa-user-plus"></i></button>
                        <button class="btn btn-grey"><i class="fa-solid fa-ellipsis"></i></button>
                    {% endif %}
                </div>

                <div class="info-row-2">
                    <div class="stat"><strong>{{ posts_count|default:"0" }}</strong> posts</div>
                    <div class="stat"><strong>{{ count_friends|default:"0" }}</strong> Friends </div>
                    <div class="stat"><strong>{{ following_count|default:"0" }}</strong> following</div>
                </div>

                <div class="info-row-3">
                    <span class="fullname">{{ profile.full_name }}</span>
                    <div class="bio">
                        {{ profile.bio|linebreaksbr }}
                    </div>
                    {% if profile.website %}
                        <a href="{{ profile.website }}" target="_blank" style="color:#00376b; font-weight:600;">{{ profile.website }}</a>
                    {% endif %}
                </div>
            </div>
        </header>

        <div class="tabs">
            <div class="tab active"><i class="fa-solid fa-table-cells"></i> POSTS</div>
            <div class="tab"><i class="fa-regular fa-bookmark"></i> SAVED</div>
            <div class="tab"><i class="fa-solid fa-user-tag"></i> TAGGED</div>
        </div>

        <div class="gallery">
            {% for post in posts %}
                <div class="gallery-item">
                    <img src="{{ post.image.url }}" alt="Post">
                    <div class="overlay">
                        <span><i class="fa-solid fa-heart"></i> {{ post.likes_count }}</span>
                        <span><i class="fa-solid fa-comment"></i> {{ post.comments_count }}</span>
                    </div>
                </div>
            {% empty %}
                <div class="gallery-item"><img src="https://picsum.photos/400?1" alt="demo"></div>
                <div class="gallery-item"><img src="https://picsum.photos/400?2" alt="demo"></div>
                <div class="gallery-item"><img src="https://picsum.photos/400?3" alt="demo"></div>
            {% endfor %}
        </div>
    </div>

    <div id="infoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <span>Account Information</span>
                <span class="close-modal">&times;</span>
            </div>
            <div class="modal-body">
                <div style="text-align:center; margin-bottom:10px;">
                    <img src="{{ profile.avatar.url|default:'https://via.placeholder.com/150' }}" style="width:80px; height:80px; border-radius:50%; object-fit:cover;">
                </div>
                
                <div class="data-row">
                    <span class="data-label">Username</span>
                    <span>{{ user.username }}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Full Name</span>
                    <span>{{ profile.full_name }}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Birth Day</span>
                    <span>{{ profile.birth_day }}</span>
                </div>
                <div class="data-row">
                    <span class="data-label">Date Joined</span>
                    <span>{{ user.date_joined | date:"F j, Y" }}</span>
                </div>
                
                {% if current_user == user %}
                    <div class="data-row">
                        <span class="data-label">Email</span>
                        <span>{{ user.email }}</span>
                    </div>
                    <div class="data-row">
                        <span class="data-label">Phone</span>
                        <span>{{ profile.phone_number }}</span>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    // Logic cho Modal
    const modal = document.getElementById("infoModal");
    const trigger = document.getElementById("usernameTrigger");
    const closeBtn = document.querySelector(".close-modal");

    // 1. Mở modal khi click vào Username
    if (trigger) {
        trigger.onclick = function() {
            modal.style.display = "block";
        }
    }

    // 2. Đóng modal khi click dấu X
    if (closeBtn) {
        closeBtn.onclick = function() {
            modal.style.display = "none";
        }
    }

    // 3. Đóng modal khi click ra vùng đen bên ngoài
    window.onclick = function(event) {
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }

    // Function create post (nếu cần dùng)
    function create() {
        window.location.href = "/posts/create/";
    }
</script>
{% endblock %}