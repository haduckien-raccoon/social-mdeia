<style>
    /* CSS cho Menu C·∫£m x√∫c */
    .reaction-container {
        position: relative;
    }
    
    .reaction-popup {
        display: none;
        position: absolute;
        bottom: 100%;
        left: 0;
        background: white;
        border-radius: 50px;
        padding: 5px 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        z-index: 100;
        white-space: nowrap;
        margin-bottom: 10px;
    }
    
    .reaction-container:hover .reaction-popup {
        display: flex;
        gap: 15px;
        animation: fadeIn 0.3s ease;
    }
    
    .reaction-icon-btn {
        font-size: 24px;
        cursor: pointer;
        transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        user-select: none;
    }
    
    .reaction-icon-btn:hover {
        transform: scale(1.4);
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

<div class="card mb-4 shadow-sm" id="post-{{ post.id }}">
    <div class="card-header d-flex justify-content-between align-items-center bg-white border-bottom-0 pt-3">
        <div class="d-flex align-items-center">
            <div class="bg-primary bg-gradient rounded-circle d-flex align-items-center justify-content-center text-white me-2 shadow-sm" 
                 style="width: 45px; height: 45px; font-weight: bold;">
                {{ post.author.username|slice:":1"|upper }}
            </div>
            <div>
                <h6 class="mb-0 fw-bold text-dark">{{ post.author.username }}</h6>
                <small class="text-muted" style="font-size: 0.85rem;">
                    {{ post.created_at|date:"H:i d/m/Y" }} 
                    &middot; 
                    {% if post.privacy == 'public' %}
                        <i class="fas fa-globe" title="C√¥ng khai"></i>
                    {% elif post.privacy == 'friends' %}
                        <i class="fas fa-user-friends" title="B·∫°n b√®"></i>
                    {% else %}
                        <i class="fas fa-lock" title="Ch·ªâ m√¨nh t√¥i"></i>
                    {% endif %}
                </small>
            </div>
        </div>
        
        {% if request.user == post.author %}
        <div class="dropdown">
            <button class="btn btn-link text-muted p-0" data-bs-toggle="dropdown">
                <i class="fas fa-ellipsis-h fa-lg"></i>
            </button>
            <ul class="dropdown-menu dropdown-menu-end shadow">
                <li><a class="dropdown-item" href="/posts/{{ post.id }}/edit/">
                    <i class="fas fa-edit me-2"></i>Ch·ªânh s·ª≠a
                </a></li>
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item text-danger" href="/posts/{{ post.id }}/delete/" onclick="return confirm('B·∫°n ch·∫Øc ch·∫Øn mu·ªën x√≥a b√†i vi·∫øt n√†y?')">
                    <i class="fas fa-trash-alt me-2"></i>X√≥a b√†i vi·∫øt
                </a></li>
            </ul>
        </div>
        {% endif %}
    </div>

    <div class="card-body">
        <p class="card-text fs-6 mb-3" style="white-space: pre-line;">{{ post.content }}</p>

        {% if post.images.all %}
        <div class="row g-1 mb-3 rounded overflow-hidden">
            {% for img in post.images.all %}
            <div class="col-{% if post.images.count == 1 %}12{% else %}6{% endif %}">
                <img src="{{ img.image.url }}" class="img-fluid w-100" 
                     style="object-fit: cover; height: {% if post.images.count == 1 %}auto{% else %}250px{% endif %}; max-height: 500px;">
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if post.files.all %}
        <div class="d-flex flex-column gap-2 mb-3">
            {% for f in post.files.all %}
            <div class="p-2 bg-light border rounded d-flex align-items-center">
                <i class="fas fa-file-alt text-primary me-3 fs-4"></i>
                <div class="overflow-hidden">
                    <a href="{{ f.file.url }}" target="_blank" class="text-decoration-none text-dark fw-bold text-truncate d-block">
                        {{ f.filename }}
                    </a>
                    <small class="text-muted">T·ªáp ƒë√≠nh k√®m</small>
                </div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <div class="card-footer bg-white border-top-0">
        <div class="d-flex justify-content-between align-items-center mb-2 px-1">
            <div class="d-flex align-items-center">
                <div class="d-flex me-1">
                    <span class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width:18px; height:18px; font-size: 10px; margin-right: -5px; z-index: 2; border: 1px solid white;">
                        <i class="fas fa-thumbs-up"></i>
                    </span>
                    <span class="bg-danger text-white rounded-circle d-flex align-items-center justify-content-center" style="width:18px; height:18px; font-size: 10px; z-index: 1; border: 1px solid white;">
                        <i class="fas fa-heart"></i>
                    </span>
                </div>
                <span class="text-muted small ms-2" id="reaction-count-{{ post.id }}">
                    {{ post.reactions.count }}
                </span>
            </div>
            
            <a href="{% url 'posts:post_detail' post.id %}" class="text-decoration-none text-muted small hover-underline">
                {{ post.comments.count }} b√¨nh lu·∫≠n
            </a>
        </div>
        
        <hr class="my-1 text-muted opacity-25">
        
        <div class="d-flex justify-content-between mt-1">
            
            <div class="reaction-container flex-grow-1">
                <div class="reaction-popup">
                    <span class="reaction-icon-btn" onclick="toggleReaction({{ post.id }}, 'like')">üëç</span>
                    <span class="reaction-icon-btn" onclick="toggleReaction({{ post.id }}, 'love')">‚ù§Ô∏è</span>
                    <span class="reaction-icon-btn" onclick="toggleReaction({{ post.id }}, 'haha')">üòÜ</span>
                    <span class="reaction-icon-btn" onclick="toggleReaction({{ post.id }}, 'wow')">üòÆ</span>
                    <span class="reaction-icon-btn" onclick="toggleReaction({{ post.id }}, 'sad')">üò¢</span>
                    <span class="reaction-icon-btn" onclick="toggleReaction({{ post.id }}, 'angry')">üò°</span>
                </div>

                <button id="btn-post-like-{{ post.id }}" 
                        class="btn btn-light w-100 py-2 border-0 rounded-3 {% if user_post_reaction %}fw-bold {{ user_post_reaction.reaction_type|yesno:'text-primary,,' }}{% else %}text-muted{% endif %}"
                        onclick="toggleReaction({{ post.id }}, 'like')">
                    
                    <i class="me-1 
                        {% if user_post_reaction.reaction_type == 'love' %}fas fa-heart text-danger
                        {% elif user_post_reaction.reaction_type == 'haha' %}fas fa-laugh-squint text-warning
                        {% elif user_post_reaction.reaction_type == 'wow' %}fas fa-surprise text-warning
                        {% elif user_post_reaction.reaction_type == 'sad' %}fas fa-sad-tear text-warning
                        {% elif user_post_reaction.reaction_type == 'angry' %}fas fa-angry text-danger
                        {% elif user_post_reaction.reaction_type == 'like' %}fas fa-thumbs-up text-primary
                        {% else %}far fa-thumbs-up{% endif %}">
                    </i>
                    
                    <span id="text-post-like-{{ post.id }}">
                        {% if user_post_reaction %}
                            {% if user_post_reaction.reaction_type == 'like' %}Th√≠ch
                            {% elif user_post_reaction.reaction_type == 'love' %}Y√™u th√≠ch
                            {% elif user_post_reaction.reaction_type == 'haha' %}Haha
                            {% elif user_post_reaction.reaction_type == 'wow' %}Wow
                            {% elif user_post_reaction.reaction_type == 'sad' %}Bu·ªìn
                            {% elif user_post_reaction.reaction_type == 'angry' %}Ph·∫´n n·ªô
                            {% endif %}
                        {% else %}
                            Th√≠ch
                        {% endif %}
                    </span>
                </button>
            </div>
            
            <a href="{% url 'posts:post_detail' post.id %}" class="btn btn-light flex-grow-1 text-muted py-2 border-0 rounded-3">
                <i class="far fa-comment-alt me-1"></i> B√¨nh lu·∫≠n
            </a>
            
            <button class="btn btn-light flex-grow-1 text-muted py-2 border-0 rounded-3" data-bs-toggle="modal" data-bs-target="#shareModal-{{ post.id }}">
                <i class="fas fa-share me-1"></i> Chia s·∫ª
            </button>
        </div>
    </div>
</div>

<div class="modal fade" id="shareModal-{{ post.id }}" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <form action="/posts/{{ post.id }}/share/" method="POST" class="w-100">
            {% csrf_token %}
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Chia s·∫ª b√†i vi·∫øt</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <textarea name="caption" class="form-control" rows="3" placeholder="H√£y n√≥i g√¨ ƒë√≥ v·ªÅ n·ªôi dung n√†y..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small">Ai c√≥ th·ªÉ nh√¨n th·∫•y tin n√†y?</label>
                        <select name="privacy" class="form-select">
                            <option value="public">C√¥ng khai</option>
                            <option value="friends">B·∫°n b√®</option>
                            <option value="only_me">Ch·ªâ m√¨nh t√¥i</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="submit" class="btn btn-primary">Chia s·∫ª ngay</button>
                </div>
            </div>
        </form>
    </div>
</div>