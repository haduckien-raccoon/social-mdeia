
<div class="card mb-3 border-0 shadow-sm" id="post-{{ post.id }}">
    <!-- Post Header -->
    <div class="card-header bg-white border-0 pb-0">
        <div class="d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
                <img src="{{ post.author.userprofile.avatar.url|default:'https://ui-avatars.com/api/?name='|add:post.author.username }}" 
                     class="rounded-circle me-2" width="40" height="40">
                <div>
                    <a href="#" class="fw-bold text-decoration-none text-dark">{{ post.author.username }}</a>
                    <div class="small text-muted">
                        {{ post.created_at|timesince }} tr∆∞·ªõc
                        {% if post.privacy == 'public' %}
                            <i class="fas fa-globe-americas"></i>
                        {% elif post.privacy == 'friends' %}
                            <i class="fas fa-user-friends"></i>
                        {% else %}
                            <i class="fas fa-lock"></i>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            {% if request.user == post.author %}
            <div class="dropdown">
                <button class="btn btn-link text-muted" data-bs-toggle="dropdown">
                    <i class="fas fa-ellipsis-h"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="{% url 'posts:post_detail' post.id %}edit/">
                        <i class="fas fa-edit me-2"></i>Ch·ªânh s·ª≠a
                    </a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="#" onclick="deletePost({{ post.id }}); return false;">
                        <i class="fas fa-trash me-2"></i>X√≥a
                    </a></li>
                </ul>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Post Content -->
    <div class="card-body">
        {% if post.content %}
        <p class="card-text">{{ post.content|linebreaks }}</p>
        {% endif %}

        <!-- Post Images -->
        {% if post.images.all %}
        <div class="row g-2 mb-2">
            {% for image in post.images.all %}
            <div class="col-{% if post.images.count == 1 %}12{% elif post.images.count == 2 %}6{% else %}4{% endif %}">
                <img src="{{ image.image.url }}" class="img-fluid rounded" style="width: 100%; object-fit: cover; max-height: 400px;">
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Post Files -->
        {% if post.files.all %}
        <div class="mb-2">
            {% for file in post.files.all %}
            <div class="border rounded p-2 mb-1">
                <i class="fas fa-file-alt me-2"></i>
                <a href="{{ file.file.url }}" download>{{ file.filename }}</a>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Tagged Users -->
        {% if post.tagged_users.all %}
        <div class="small text-muted mb-2">
            <i class="fas fa-user-tag me-1"></i>
            C√πng v·ªõi
            {% for tag in post.tagged_users.all %}
                <a href="#" class="text-decoration-none">{{ tag.user.username }}</a>{% if not forloop.last %}, {% endif %}
            {% endfor %}
        </div>
        {% endif %}

        <!-- Location -->
        {% if post.locations.first %}
        <div class="small text-muted mb-2">
            <i class="fas fa-map-marker-alt me-1"></i>
            {{ post.locations.first.name }}
        </div>
        {% endif %}
    </div>

    <!-- Post Stats -->
    <div class="card-footer bg-white border-0 pt-0">
        <div class="d-flex justify-content-between text-muted small mb-2">
            <span>
                {% if not post.hide_reaction_count %}
                <i class="fas fa-thumbs-up text-primary"></i>
                <span id="reaction-count-{{ post.id }}">
                    {{ post.reaction_count|default:post.reactions.count }}
                </span>
                {% endif %}
            </span>
            <span>
                {% if not post.hide_comment_count %}
                <span id="comment-count-{{ post.id }}">
                    {{ post.comment_count|default:post.comments.count }}
                </span> b√¨nh lu·∫≠n
                {% endif %}
            </span>
        </div>

        <hr>

        <!-- Action Buttons -->
        <div class="row g-2 text-center">
            <!-- Like Button -->
            <div class="col-4">
                <div class="position-relative">
                    <button class="btn w-100 reaction-btn {% if post.current_user_reaction %}reaction-active{% else %}text-muted{% endif %}" 
                            id="btn-post-like-{{ post.id }}"
                            onclick="showReactionPicker({{ post.id }})"
                            onmouseover="delayShowReactions({{ post.id }})"
                            onmouseout="hideReactions({{ post.id }})">
                        <i class="fas fa-thumbs-up me-1"></i>
                        <span id="text-post-like-{{ post.id }}">
                            {% if post.current_user_reaction %}
                                {% if post.current_user_reaction == 'like' %}Th√≠ch
                                {% elif post.current_user_reaction == 'love' %}Y√™u th√≠ch
                                {% elif post.current_user_reaction == 'haha' %}Haha
                                {% elif post.current_user_reaction == 'sad' %}Bu·ªìn
                                {% elif post.current_user_reaction == 'angry' %}Ph·∫´n n·ªô
                                {% endif %}
                            {% else %}
                                Th√≠ch
                            {% endif %}
                        </span>
                    </button>
                    
                    <!-- Reaction Picker -->
                    <div id="reaction-picker-{{ post.id }}" class="reaction-picker">
                        <span class="reaction-emoji" onclick="toggleReaction({{ post.id }}, 'like');" title="Th√≠ch">üëç</span>
                        <span class="reaction-emoji" onclick="toggleReaction({{ post.id }}, 'love')" title="Y√™u th√≠ch">‚ù§Ô∏è</span>
                        <span class="reaction-emoji" onclick="toggleReaction({{ post.id }}, 'haha')" title="Haha">üòÇ</span>
                        <span class="reaction-emoji" onclick="toggleReaction({{ post.id }}, 'sad')" title="Bu·ªìn">üò¢</span>
                        <span class="reaction-emoji" onclick="toggleReaction({{ post.id }}, 'angry')" title="Ph·∫´n n·ªô">üò†</span>
                    </div>
                </div>
            </div>

            <!-- Comment Button -->
            <div class="col-4">
                <a href="{% url 'posts:post_detail' post.id %}" class="btn w-100 text-muted">
                    <i class="fas fa-comment me-1"></i>
                    B√¨nh lu·∫≠n
                </a>
            </div>

            <!-- Share Button -->
            <div class="col-4">
                <button class="btn w-100 text-muted" onclick="sharePost({{ post.id }})">
                    <i class="fas fa-share me-1"></i>
                    Chia s·∫ª
                </button>
            </div>
        </div>
    </div>
</div>
{% block scripts %}

<script>
    /**
 * Global JavaScript cho Posts App
 * File n√†y ch·ª©a c√°c h√†m d√πng chung cho feed.html v√† post_detail.html
 */

// ========================================
// 1. CSRF TOKEN HELPER
// ========================================
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Global CSRF token
const csrftoken = getCookie('csrftoken');

// ========================================
// 2. REACTION FUNCTIONS
// ========================================
let reactionTimeout;

function delayShowReactions(postId) {
    clearTimeout(reactionTimeout);
    reactionTimeout = setTimeout(() => {
        const picker = document.getElementById(`reaction-picker-${postId}`);
        if (picker) picker.style.display = 'block';
    }, 500);
}

function hideReactions(postId) {
    clearTimeout(reactionTimeout);
    setTimeout(() => {
        const picker = document.getElementById(`reaction-picker-${postId}`);
        if (picker) picker.style.display = 'none';
    }, 300);
}

function showReactionPicker(postId) {
    const picker = document.getElementById(`reaction-picker-${postId}`);
    if (picker) {
        const isVisible = picker.style.display === 'block';
        // Hide all other pickers
        document.querySelectorAll('.reaction-picker').forEach(p => p.style.display = 'none');
        // Toggle current picker
        picker.style.display = isVisible ? 'none' : 'block';
    }
}

function toggleReaction(postId, type = 'like') {
    const btn = document.getElementById(`btn-post-like-${postId}`);
    const text = document.getElementById(`text-post-like-${postId}`);
    const countSpan = document.getElementById(`reaction-count-${postId}`);
    
    // Hide reaction picker
    const picker = document.getElementById(`reaction-picker-${postId}`);
    if (picker) picker.style.display = 'none';
    
    // Send request
    fetch(`/posts/${postId}/reaction/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: `reaction=${type}`
    })
    .then(res => {
        if (!res.ok) throw new Error("Network error");
        return res.json();
    })
    .then(data => {
        // Update UI
        if (data.status === 'added' || data.status === 'changed') {
            btn.classList.add('reaction-active');
            btn.classList.remove('text-muted');
            
            const reactionNames = {
                'like': 'Th√≠ch',
                'love': 'Y√™u th√≠ch',
                'haha': 'Haha',
                'sad': 'Bu·ªìn',
                'angry': 'Ph·∫´n n·ªô'
            };
            text.innerText = reactionNames[type] || 'Th√≠ch';
        } else {
            btn.classList.remove('reaction-active');
            btn.classList.add('text-muted');
            text.innerText = "Th√≠ch";
        }
        
        // Update count
        if (countSpan && data.total_count !== undefined) {
            countSpan.innerText = data.total_count;
        }
    })
    .catch(err => {
        console.error('Reaction error:', err);
        alert('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.');
    });
}

// ========================================
// 3. POST ACTIONS
// ========================================
function sharePost(postId) {
    const caption = prompt("Vi·∫øt l·ªùi nh·∫Øn khi chia s·∫ª (t√πy ch·ªçn):");
    if (caption !== null) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/posts/${postId}/share/`;
        
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrftoken;
        
        const captionInput = document.createElement('input');
        captionInput.type = 'hidden';
        captionInput.name = 'caption';
        captionInput.value = caption;
        
        form.appendChild(csrfInput);
        form.appendChild(captionInput);
        document.body.appendChild(form);
        form.submit();
    }
}

function deletePost(postId) {
    if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√†i vi·∫øt n√†y?")) {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/posts/${postId}/delete/`;
        
        const csrfInput = document.createElement('input');
        csrfInput.type = 'hidden';
        csrfInput.name = 'csrfmiddlewaretoken';
        csrfInput.value = csrftoken;
        
        form.appendChild(csrfInput);
        document.body.appendChild(form);
        form.submit();
    }
}

// ========================================
// 4. COMMENT FUNCTIONS (for post_detail.html)
// ========================================
// --- 2. H√ÄM G·ª¨I COMMENT (ƒê√£ s·ª≠a ID) ---
// function submitComment(parentId = null) {
//         // S·ª¨A L·ªñI 1: ƒê·ªìng b·ªô ID gi·ªØa HTML v√† JS
//         // N·∫øu l√† comment ch√≠nh (kh√¥ng c√≥ parentId) -> d√πng id "main-comment-input"
//         const inputId = parentId ? `reply-input-${parentId}` : 'main-comment-input';
        
//         const contentInput = document.getElementById(inputId);
//         if (!contentInput) {
//             console.error("Kh√¥ng t√¨m th·∫•y √¥ nh·∫≠p li·ªáu v·ªõi ID:", inputId);
//             return;
//         }

//         const content = contentInput.value.trim();
//         const filesInput = document.getElementById('comment-files'); // Input file ·∫©n (n·∫øu c√≥)

//         // Ki·ªÉm tra d·ªØ li·ªáu r·ªóng
//         if (!content && (!filesInput || filesInput.files.length === 0)) {
//             return;
//         }

//         let formData = new FormData();
//         formData.append('content', content);
//         if (parentId) formData.append('parent_id', parentId);
        
//         // Ch·ªâ g·ª≠i file n·∫øu l√† comment ch√≠nh (form ph·ª• th∆∞·ªùng kh√¥ng c√≥ n√∫t attach file)
//         if (!parentId && filesInput) {
//             for (let i = 0; i < filesInput.files.length; i++) {
//                 formData.append('images', filesInput.files[i]);
//             }
//         }

//         // G·ª≠i Ajax
//         fetch(`/posts/${POST_ID}/comment/`, {
//             method: 'POST',
//             headers: { 
//                 'X-CSRFToken': csrftoken 
//             },
//             body: formData
//         })
//         .then(response => {
//             if (!response.ok) throw new Error("G·ª≠i th·∫•t b·∫°i");
//             return response.json();
//         })
//         .then(data => {
//             console.log("Th√†nh c√¥ng:", data);
//             // X√≥a n·ªôi dung sau khi g·ª≠i th√†nh c√¥ng
//             contentInput.value = '';
            
//             if (parentId) {
//                 // ·∫®n form tr·∫£ l·ªùi
//                 const replyBox = document.getElementById(`reply-form-${parentId}`);
//                 if (replyBox) replyBox.classList.add('d-none');
//             } else {
//                 // Reset form ch√≠nh
//                 if (filesInput) filesInput.value = '';
//                 const preview = document.getElementById('main-preview');
//                 if (preview) preview.innerHTML = '';
//             }
//         })
//         .catch(error => console.error("L·ªói:", error));
//     }

//     // --- 3. ƒê·∫¢M B·∫¢O H√ÄM GLOBAL (Tr√°nh l·ªói ReferenceError) ---
//     window.submitComment = submitComment;
// --- S·ª¨A L·∫†I H√ÄM N√ÄY ---
function submitComment(postId, parentId = null) {
    // T·∫°o ID ƒë·ªông d·ª±a tr√™n postId ƒë·ªÉ tr√°nh tr√πng l·∫∑p
    const inputId = parentId ? `reply-input-${parentId}` : 'main-comment-input';
    
    const contentInput = document.getElementById(inputId);
    if (!contentInput) return; // Kh√¥ng t√¨m th·∫•y input th√¨ d·ª´ng

    const content = contentInput.value.trim();
    const filesInput = document.getElementById('comment-files');

    if (!content && (!filesInput || filesInput.files.length === 0)) return;

    let formData = new FormData();
    formData.append('content', content);
    if (parentId) formData.append('parent_id', parentId);
    
    if (!parentId && filesInput) {
        for (let i = 0; i < filesInput.files.length; i++) {
            formData.append('images', filesInput.files[i]);
        }
    }

    // D√πng postId ƒë∆∞·ª£c truy·ªÅn v√†o thay v√¨ POST_ID to√†n c·ª•c
    fetch(`/posts/${postId}/comment/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'ok') {
            contentInput.value = ''; // X√≥a n·ªôi dung input
            
            if (parentId) {
                // ·∫®n form tr·∫£ l·ªùi (Ch√∫ √Ω ID ph·∫£i kh·ªõp v·ªõi HTML)
                const replyForm = document.getElementById(`reply-form-${parentId}`);
                if (replyForm) replyForm.classList.add('d-none');
            } else {
                // Reset file input n·∫øu l√† comment ch√≠nh
                if (filesInput) filesInput.value = '';
                const preview = document.getElementById('main-preview');
                if (preview) preview.innerHTML = '';
            }
        } else {
            alert(data.error || 'C√≥ l·ªói x·∫£y ra');
        }
    })
    .catch(error => console.error("L·ªói:", error));
}

function toggleCommentLike(commentId) {
    fetch(`/posts/comment/${commentId}/reaction/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrftoken,
            'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: 'reaction=like'
    })
    .then(res => res.json())
    .then(data => {
        const linkEl = document.getElementById(`comment-like-${commentId}`);
        if (linkEl) {
            if (data.status === 'added' || data.status === 'changed') {
                linkEl.classList.add('text-primary', 'fw-bold');
                linkEl.classList.remove('text-muted');
            } else {
                linkEl.classList.remove('text-primary', 'fw-bold');
                linkEl.classList.add('text-muted');
            }
        }
    })
    .catch(err => console.error('Comment reaction error:', err));
}

function deleteComment(commentId) {
    if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√¨nh lu·∫≠n n√†y?")) return;
    
    fetch(`/posts/comment/${commentId}/delete/`, {
        method: 'POST',
        headers: {'X-CSRFToken': csrftoken}
    })
    .then(res => res.json())
    .then(data => {
        if (data.status !== 'ok') {
            alert(data.error || 'C√≥ l·ªói x·∫£y ra');
        }
    })
    .catch(err => console.error('Delete comment error:', err));
}

function showReply(commentId) {
    const box = document.getElementById(`reply-box-${commentId}`);
    if (box) {
        box.classList.toggle('d-none');
        if (!box.classList.contains('d-none')) {
            const input = box.querySelector('input');
            if (input) input.focus();
        }
    }
}

// ========================================
// 5. UTILITY FUNCTIONS
// ========================================
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ========================================
// 6. GLOBAL EVENT LISTENERS
// ========================================
document.addEventListener('DOMContentLoaded', function() {
    // Close reaction pickers when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.reaction-btn') && !e.target.closest('.reaction-picker')) {
            document.querySelectorAll('.reaction-picker').forEach(p => p.style.display = 'none');
        }
    });
    
    console.log('‚úÖ Posts.js loaded successfully');
});
</script>
{% endblock %}