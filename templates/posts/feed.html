{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<style>
    /* =========================================
       FACEBOOK CLONE STYLES
       ========================================= */
    :root {
        --bg-body: #f0f2f5;
        --bg-card: #ffffff;
        --text-main: #050505;
        --text-sub: #65676b;
        --primary: #1877f2;
        --hover-bg: #f2f2f2;
        --radius: 8px;
        --shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    body { background-color: var(--bg-body); color: var(--text-main); }

    /* LAYOUT */
    .fb-layout { display: flex; justify-content: space-between; padding-top: 20px; }
    .sidebar-left, .sidebar-right { width: 280px; position: sticky; top: 80px; height: calc(100vh - 90px); overflow-y: auto; display: none; }
    .feed-center { flex: 1; max-width: 680px; margin: 0 auto; padding: 0 16px; }
    @media (min-width: 992px) { .sidebar-left, .sidebar-right { display: block; } }

    /* ITEMS & CARDS */
    .nav-item-fb { display: flex; align-items: center; padding: 10px; border-radius: var(--radius); text-decoration: none; color: var(--text-main); font-weight: 500; transition: 0.2s; }
    .nav-item-fb:hover { background-color: #e4e6eb; color: var(--text-main); }
    .nav-item-fb img { width: 36px; height: 36px; border-radius: 50%; margin-right: 12px; }
    
    .create-post { background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow); padding: 12px 16px; margin-bottom: 20px; }
    .cp-top { display: flex; align-items: center; border-bottom: 1px solid #f0f2f5; padding-bottom: 12px; margin-bottom: 12px; }
    .cp-input { flex: 1; background: #f0f2f5; border-radius: 20px; padding: 10px 15px; color: #65676b; cursor: pointer; margin-left: 10px; }
    .cp-input:hover { background: #e4e6eb; }
    .cp-actions { display: flex; }
    .cp-btn { flex: 1; display: flex; justify-content: center; align-items: center; padding: 8px; border-radius: var(--radius); cursor: pointer; color: #65676b; font-weight: 600; }
    .cp-btn:hover { background: #f2f2f2; }

    /* POST STYLES */
    .post-card { background: var(--bg-card); border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 16px; overflow: visible; }
    .post-header { padding: 12px 16px; display: flex; align-items: center; }
    .p-avatar { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
    .p-info h5 { margin: 0; font-size: 15px; font-weight: 600; }
    .p-info h5 a { text-decoration: none; color: inherit; }
    .p-time { font-size: 13px; color: var(--text-sub); }
    .post-content { padding: 4px 16px 16px; font-size: 15px; line-height: 1.5; }

    /* SHARED POST */
    .shared-box { border: 1px solid #ddd; border-radius: 8px; margin: 0 16px 16px; overflow: hidden; cursor: pointer; }
    .shared-box:hover { background: #f7f8fa; }
    .sb-header { padding: 10px; display: flex; align-items: center; border-bottom: 1px solid #eee; }
    .sb-avatar { width: 32px; height: 32px; border-radius: 50%; margin-right: 8px; }

    /* IMAGE GRID */
    .img-grid { display: grid; gap: 1px; overflow: hidden; cursor: pointer; background: #fff; }
    .grid-1 { grid-template-columns: 1fr; }
    .grid-2 { grid-template-columns: 1fr 1fr; height: 300px; }
    .grid-3 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; height: 360px; }
    .grid-3 .grid-item:first-child { grid-row: span 2; }
    .grid-4 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; height: 360px; }
    .grid-item { position: relative; width: 100%; height: 100%; }
    .grid-item img { width: 100%; height: 100%; object-fit: cover; display: block; }
    .more-overlay { position: absolute; inset: 0; background: rgba(0,0,0,0.4); color: #fff; font-size: 24px; font-weight: bold; display: flex; justify-content: center; align-items: center; }

    /* STATS & ACTIONS */
    .p-stats { padding: 10px 16px; border-bottom: 1px solid #ced0d4; display: flex; justify-content: space-between; font-size: 14px; color: var(--text-sub); }
    .p-actions { display: flex; padding: 4px; border-top: 1px solid transparent; position: relative; }
    
    .action-btn { flex: 1; display: flex; justify-content: center; align-items: center; height: 36px; border-radius: 4px; cursor: pointer; color: var(--text-sub); font-weight: 600; font-size: 14px; background: transparent; transition: 0.2s; gap: 6px;}
    .action-btn:hover { background-color: var(--hover-bg); }

    /* --- REACTION SYSTEM (Gi·ªëng Post Detail) --- */
    .reaction-wrapper { flex: 1; position: relative; display: flex; }
    /* V√πng ƒë·ªám v√¥ h√¨nh ƒë·ªÉ kh√¥ng m·∫•t hover khi di chu·ªôt t·ª´ n√∫t l√™n popup */
    .reaction-wrapper::after { content: ''; position: absolute; bottom: 100%; left: 0; width: 100%; height: 15px; display: none; }
    .reaction-wrapper:hover::after { display: block; }

    .reaction-popup {
        position: absolute; bottom: 100%; left: 0; margin-bottom: 5px;
        background: #fff; border-radius: 50px; padding: 6px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: none; gap: 8px; z-index: 1000;
        animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .reaction-wrapper:hover .reaction-popup { display: flex; }
    
    .emoji-btn { font-size: 24px; cursor: pointer; transition: transform 0.2s; line-height: 1; }
    .emoji-btn:hover { transform: scale(1.4); }

    /* Reaction Colors */
    .active-like, .text-like { color: var(--primary) !important; }
    .active-love, .text-love { color: #f33e58 !important; }
    .active-haha, .active-wow, .active-sad, .text-haha, .text-wow, .text-sad { color: #f7b125 !important; }
    .active-angry, .text-angry { color: #e9710f !important; }

    @keyframes popUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* MODAL */
    .share-modal { position: fixed; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 2000; }
    .share-box { background: #fff; width: 100%; max-width: 500px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); border: 1px solid #ddd; overflow: hidden; }
    .share-header { padding: 15px; border-bottom: 1px solid #eee; text-align: center; font-weight: 700; font-size: 20px; position: relative; }
    .share-body { padding: 15px; }
    .share-user { display: flex; align-items: center; margin-bottom: 15px; }
    .share-user img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }
    .share-privacy { background: #e4e6eb; border: none; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; }
    .share-caption { width: 100%; border: none; outline: none; font-size: 16px; resize: none; min-height: 80px; margin-bottom: 15px; }
    .share-preview { border: 1px solid #ced0d4; border-radius: 8px; padding: 10px; margin-bottom: 15px; background: #f7f8fa; }
    .share-actions { display: flex; justify-content: flex-end; gap: 10px; }
    .btn-share-submit { background: #0064fb;; color: #fff; border: none; padding: 8px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; }
    .btn-share-cancel { background: #e4e6eb; color: var(--text-main); border: none; padding: 8px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; }
    .close-btn { position: absolute; right: 15px; top: 15px; cursor: pointer; font-size: 24px; color: #65676b; line-height: 1; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="fb-layout">
        {% comment %} <div class="sidebar-left">
            <a href="{% url 'accounts:profile' request.user.username %}" class="nav-item-fb">
                <img src="{{ request.user.profile.avatar.url|default:'images/avatars/normal.jpg' }}">
                <span>{{ request.user.username }}</span>
            </a>
            <a href="#" class="nav-item-fb"><i class="fas fa-user-friends"></i> B·∫°n b√®</a>
            <a href="#" class="nav-item-fb"><i class="fas fa-users"></i> Nh√≥m</a>
            <a href="#" class="nav-item-fb"><i class="fas fa-history"></i> K·ª∑ ni·ªám</a>
            <hr>
        </div> {% endcomment %}

        <div class="feed-center">
            <div class="create-post">
                <div class="cp-top">
                    <img src="{{ request.user.profile.avatar.url|default:'images/avatars/normal.jpg' }}" style="width:40px; height:40px; border-radius:50%">
                    <div class="cp-input" onclick="window.location.href='{% url 'posts:create' %}'">
                        {{ request.user.username }} ∆°i, b·∫°n ƒëang nghƒ© g√¨ th·∫ø?
                    </div>
                </div>
                <div class="cp-actions">
                    {% comment %} <div class="cp-btn"><i class="fas fa-video text-danger me-2"></i> Tr·ª±c ti·∫øp</div> {% endcomment %}
                    <div class="cp-btn" onclick="window.location.href='{% url 'posts:create' %}'"><i class="fas fa-images text-success me-2"></i> ·∫¢nh</div>
                    <div class="cp-btn" onclick="window.location.href='{% url 'posts:create' %}'"><i class="far fa-smile text-warning me-2"></i> C·∫£m x√∫c</div>
                </div>
            </div>

            {% for post in posts %}
            <div class="post-card" id="post-{{ post.id }}">
                <div class="post-header">
                    <a href="{% url 'accounts:profile' post.author.username %}">
                        <img src="{{ post.author.profile.avatar.url|default:'images/avatars/normal.jpg' }}" class="p-avatar">
                    </a>
                    <div class="p-info">
                        <h5><a href="{% url 'accounts:profile' post.author.username %}">{{ post.author.username }}</a></h5>
                        <div class="p-time">
                            {{ post.created_at|timesince }} tr∆∞·ªõc ‚Ä¢ 
                            {% if post.privacy == 'public' %}<i class="fas fa-globe-americas"></i>
                            {% elif post.privacy == 'friends' %}<i class="fas fa-user-friends"></i>
                            {% else %}<i class="fas fa-lock"></i>{% endif %}
                        </div>
                    </div>
                </div>

                <div class="post-content">{{ post.content|linebreaksbr }}</div>

                {% if post.original_post_obj %}
                <div class="shared-box" onclick="window.location.href='{% url 'posts:post_detail' post.original_post_obj.id %}'">
                    <div class="sb-header">
                        <img src="{{ post.original_post_obj.author.profile.avatar.url|default:'images/avatars/normal.jpg' }}" class="sb-avatar">
                        <div>
                            <strong>{{ post.original_post_obj.author.username }}</strong>
                            <div class="small text-muted">{{ post.original_post_obj.created_at|timesince }} tr∆∞·ªõc</div>
                        </div>
                    </div>
                    <div class="p-3">
                        {{ post.original_post_obj.content|truncatechars:150 }}
                    </div>
                    {% if post.original_post_obj.images.all %}
                        {% with total=post.original_post_obj.images.count %}
                        <div class="img-grid grid-{% if total > 4 %}4{% else %}{{ total }}{% endif %}">
                            {% for img in post.original_post_obj.images.all|slice:":4" %}
                            <div class="grid-item">
                                <img src="{{ img.image.url }}">
                                {% if forloop.last and total > 4 %}<div class="more-overlay">+{{ total|add:"-3" }}</div>{% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        {% endwith %}
                    {% endif %}
                </div>
                {% elif post.shared_post.exists and not post.original_post_obj %}
                    <div class="alert alert-warning m-3">B√†i vi·∫øt g·ªëc ƒë√£ b·ªã x√≥a.</div>
                {% endif %}

                {% if post.images.all and not post.original_post_obj %}
                    {% with total=post.images.count %}
                    <a href="{% url 'posts:post_detail' post.id %}" style="display:block">
                        <div class="img-grid grid-{% if total > 4 %}4{% else %}{{ total }}{% endif %}">
                            {% for img in post.images.all|slice:":4" %}
                            <div class="grid-item">
                                <img src="{{ img.image.url }}">
                                {% if forloop.last and total > 4 %}<div class="more-overlay">+{{ total|add:"-3" }}</div>{% endif %}
                            </div>
                            {% endfor %}
                        </div>
                    </a>
                    {% endwith %}
                {% endif %}

                <div class="p-stats">
                    <div id="count-{{ post.id }}">
                        {% if post.reaction_count > 0 %}
                        <i class="fas fa-thumbs-up text-primary"></i> {{ post.reaction_count }}
                        {% endif %}
                    </div>
                    <div>{{ post.comment_count }} b√¨nh lu·∫≠n</div>
                </div>

                <div class="p-actions">
                    <div class="reaction-wrapper">
                        <div class="reaction-popup">
                            <span class="emoji-btn" onclick="submitReact({{ post.id }}, 'like')">üëç</span>
                            <span class="emoji-btn" onclick="submitReact({{ post.id }}, 'love')">‚ù§Ô∏è</span>
                            <span class="emoji-btn" onclick="submitReact({{ post.id }}, 'haha')">üòÜ</span>
                            <span class="emoji-btn" onclick="submitReact({{ post.id }}, 'wow')">üòÆ</span>
                            <span class="emoji-btn" onclick="submitReact({{ post.id }}, 'sad')">üò¢</span>
                            <span class="emoji-btn" onclick="submitReact({{ post.id }}, 'angry')">üò°</span>
                        </div>
                        <div class="action-btn {% if post.current_user_reaction %}active-{{ post.current_user_reaction }}{% endif %}" 
                             id="btn-react-{{ post.id }}" 
                             onclick="submitReact({{ post.id }}, 'like')"
                             style="width: 100%;">
                            
                            {% if post.current_user_reaction == 'like' %} <i class="fas fa-thumbs-up"></i> Th√≠ch
                            {% elif post.current_user_reaction == 'love' %} <i class="fas fa-heart"></i> Y√™u th√≠ch
                            {% elif post.current_user_reaction == 'haha' %} <i class="fas fa-laugh-squint"></i> Haha
                            {% elif post.current_user_reaction == 'sad' %} <i class="fas fa-sad-tear"></i> Bu·ªìn
                            {% elif post.current_user_reaction == 'wow' %} <i class="fas fa-surprise"></i> Wow
                            {% elif post.current_user_reaction == 'angry' %} <i class="fas fa-angry"></i> Ph·∫´n n·ªô
                            {% else %} <i class="far fa-thumbs-up"></i> Th√≠ch
                            {% endif %}
                        </div>
                    </div>

                    <div class="action-btn" onclick="window.location.href='{% url 'posts:post_detail' post.id %}'">
                        <i class="far fa-comment-alt me-2"></i> B√¨nh lu·∫≠n
                    </div>
                    <div class="action-btn" onclick="openShareModal({{ post.id }})">
                        <i class="fas fa-share me-2"></i> Chia s·∫ª
                    </div>
                </div>
            </div>

            <div id="shareModal-{{ post.id }}" class="share-modal" onclick="closeShareModal(event, {{ post.id }})">
                <div class="share-box">
                    <div class="share-header">
                        Chia s·∫ª b√†i vi·∫øt
                        <span class="close-btn" onclick="closeShareModal(null, {{ post.id }})">&times;</span>
                    </div>
                    <form action="{% url 'posts:share_post' post.id %}" method="POST" class="share-body">
                        {% csrf_token %}
                        <div class="share-user">
                            <img src="{{ request.user.profile.avatar.url|default:'images/avatars/normal.jpg' }}">
                            <div>
                                <div style="font-weight: 600;">{{ request.user.username }}</div>
                                <select name="privacy" class="share-privacy">
                                    <option value="public">üåç C√¥ng khai</option>
                                    <option value="friends">üë• B·∫°n b√®</option>
                                    <option value="only_me">üîí Ch·ªâ m√¨nh t√¥i</option>
                                </select>
                            </div>
                        </div>
                        <textarea name="caption" class="share-caption" placeholder="H√£y n√≥i g√¨ ƒë√≥ v·ªÅ n·ªôi dung n√†y..."></textarea>
                        
                        <div class="share-preview">
                            {% if post.original_post_obj %}
                                <div class="small fw-bold mb-1">B√†i vi·∫øt c·ªßa {{ post.original_post_obj.author.username }}</div>
                                <div class="text-muted small">{{ post.original_post_obj.content|truncatechars:100 }}</div>
                            {% else %}
                                <div class="small fw-bold mb-1">B√†i vi·∫øt c·ªßa {{ post.author.username }}</div>
                                <div class="text-muted small">{{ post.content|truncatechars:100 }}</div>
                            {% endif %}
                        </div>

                        <div class="share-actions">
                            <button type="button" class="btn-share-cancel" onclick="closeShareModal(null, {{ post.id }})">H·ªßy</button>
                            <button type="submit" class="btn-share-submit">Chia s·∫ª ngay</button>
                        </div>
                    </form>
                </div>
            </div>
            {% empty %}
                <div class="text-center p-5 text-muted">Ch∆∞a c√≥ b√†i vi·∫øt n√†o.</div>
            {% endfor %}
        </div>

        {% comment %} <div class="sidebar-right">
            <div class="fw-bold text-muted small mb-3">NG∆Ø·ªúI LI√äN H·ªÜ</div>
            <div class="nav-item-fb">
                <div style="position:relative">
                    <img src="https://ui-avatars.com/api/?name=Admin">
                    <div style="position:absolute; bottom:0; right:12px; width:10px; height:10px; background:#31a24c; border-radius:50%; border:2px solid #fff"></div>
                </div>
                <span>Admin User</span>
            </div>
        </div> {% endcomment %}

    </div>
</div>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // --- REACTION LOGIC (Updated to handle different types) ---
    function submitReact(postId, type) {
        fetch(`/posts/${postId}/reaction/`, {
            method: 'POST',
            headers: {'X-CSRFToken': csrftoken, 'Content-Type': 'application/x-www-form-urlencoded'},
            body: `reaction=${type}`
        })
        .then(res => res.json())
        .then(data => {
            const btn = document.getElementById(`btn-react-${postId}`);
            const countDiv = document.getElementById(`count-${postId}`);
            
            // Reset base class
            btn.className = 'action-btn'; 

            if (data.status === 'removed') {
                btn.innerHTML = `<i class="far fa-thumbs-up"></i> Th√≠ch`;
            } else {
                // Add active class color (e.g., active-love)
                btn.classList.add(`active-${type}`);
                
                // Update Icon & Text based on type
                const map = { 'like':'Th√≠ch', 'love':'Y√™u th√≠ch', 'haha':'Haha', 'wow':'Wow', 'sad':'Bu·ªìn', 'angry':'Ph·∫´n n·ªô' };
                const icons = { 'like':'thumbs-up', 'love':'heart', 'haha':'laugh-squint', 'wow':'surprise', 'sad':'sad-tear', 'angry':'angry' };
                
                btn.innerHTML = `<i class="fas fa-${icons[type]}"></i> ${map[type]}`;
            }

            // Update Total Count
            if(data.total_count > 0) {
                countDiv.innerHTML = `<i class="fas fa-thumbs-up text-primary"></i> ${data.total_count}`;
            } else {
                countDiv.innerHTML = '';
            }
        });
    }

    // --- SHARE MODAL LOGIC ---
    function openShareModal(postId) {
        const modal = document.getElementById(`shareModal-${postId}`);
        if(modal) {
            modal.style.display = 'flex';
            const input = modal.querySelector('.share-caption');
            if(input) input.focus();
        }
    }

    function closeShareModal(event, postId) {
        const modal = document.getElementById(`shareModal-${postId}`);
        if (!modal) return;
        if (!event || event.target === modal) {
            modal.style.display = 'none';
        }
    }
</script>
{% endblock %}