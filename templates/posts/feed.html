{% extends 'base.html' %}

{% block content %}
<style>
    /* Container để định vị popup */
    .reaction-container {
        position: relative;
    }
    
    /* Menu cảm xúc (mặc định ẩn) */
    .reaction-popup {
        display: none;
        position: absolute;
        bottom: 100%; /* Hiện phía trên nút */
        left: 0;
        background: white;
        border-radius: 50px;
        padding: 5px 15px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        z-index: 1000;
        white-space: nowrap;
        margin-bottom: 10px;
    }
    
    /* HIỆN MENU KHI RÊ CHUỘT (HOVER) */
    .reaction-container:hover .reaction-popup {
        display: flex;
        gap: 10px;
        animation: fadeIn 0.3s ease;
    }
    
    /* Hiệu ứng icon trong menu */
    .reaction-icon-btn {
        font-size: 24px;
        cursor: pointer;
        transition: transform 0.2s;
        user-select: none;
    }
    
    .reaction-icon-btn:hover {
        transform: scale(1.3);
    }

    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

<div class="row justify-content-center">
    <div class="col-md-8">
        <h4 class="mb-4 text-secondary">Bảng tin</h4>
        
        {% if not posts %}
            <div class="alert alert-info text-center">Chưa có bài viết nào để hiển thị.</div>
        {% endif %}

        {% for post in posts %}
            {% include 'posts/includes/post_card.html' %}
        {% endfor %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // 1. Cấu hình hiển thị cho từng loại reaction
    const REACTION_CONFIG = {
        'like':  { icon: 'fa-thumbs-up', colorClass: 'text-primary', label: 'Thích' },
        'love':  { icon: 'fa-heart',     colorClass: 'text-danger',  label: 'Yêu thích' },
        'haha':  { icon: 'fa-laugh-squint', colorClass: 'text-warning', label: 'Haha' },
        'wow':   { icon: 'fa-surprise',  colorClass: 'text-warning', label: 'Wow' },
        'sad':   { icon: 'fa-sad-tear',  colorClass: 'text-warning', label: 'Buồn' },
        'angry': { icon: 'fa-angry',     colorClass: 'text-danger',  label: 'Phẫn nộ' }
    };

    // 2. Hàm xử lý Reaction (Nhận thêm tham số type)
    function toggleReaction(postId, type = 'like') {
        const btn = document.getElementById(`btn-post-like-${postId}`);
        const countSpan = document.getElementById(`reaction-count-${postId}`);
        const textSpan = document.getElementById(`text-post-like-${postId}`);

        // Gọi API (Lưu ý đường dẫn đã thêm /posts/)
        fetch(`/posts/${postId}/reaction/`, { 
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `reaction=${type}` // Gửi đúng loại reaction (love, haha...)
        })
        .then(response => response.json())
        .then(data => {
            // Xử lý cập nhật UI dựa trên phản hồi server
            // data.status trả về: 'added', 'removed', hoặc 'changed'
            
            let currentCount = parseInt(countSpan.innerText) || 0;

            if (data.status === 'added') {
                // Tăng số lượng
                countSpan.innerText = currentCount + 1;
                updateButtonUI(btn, textSpan, type, true);

            } else if (data.status === 'removed') {
                // Giảm số lượng
                countSpan.innerText = Math.max(0, currentCount - 1);
                updateButtonUI(btn, textSpan, null, false);

            } else if (data.status === 'changed') {
                // Số lượng giữ nguyên, chỉ đổi icon/màu
                updateButtonUI(btn, textSpan, type, true);
            }
        })
        .catch(error => console.error('Error:', error));
    }

    // 3. Hàm cập nhật giao diện nút bấm (Màu sắc & Icon)
    function updateButtonUI(btn, textSpan, type, isActive) {
        // Reset class cũ
        btn.className = "btn btn-light w-100 py-2 border-0 rounded-3";
        const iconTag = btn.querySelector('i');
        
        // Reset icon
        iconTag.className = "me-1"; 

        if (!isActive) {
            // Trạng thái: Chưa like (Removed)
            btn.classList.add('text-muted');
            iconTag.classList.add('far', 'fa-thumbs-up'); // Icon rỗng
            if(textSpan) textSpan.innerText = "Thích";
        } else {
            // Trạng thái: Đã like (Added/Changed)
            const config = REACTION_CONFIG[type] || REACTION_CONFIG['like'];
            
            btn.classList.add('fw-bold'); 
            // Thêm màu và icon tương ứng
            iconTag.classList.add('fas', config.icon, config.colorClass); 
            btn.classList.add(config.colorClass); // Tô màu chữ nút

            if(textSpan) textSpan.innerText = config.label;
        }
    }
</script>
{% endblock %}