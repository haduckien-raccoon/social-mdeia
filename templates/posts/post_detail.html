{% extends 'posts/base_posts.html' %}

{% block extra_css %}
{{ block.super }}
<style>
    .comment-wrapper {
        padding: 8px 0;
        border-left: 2px solid transparent;
        margin-bottom: 8px;
        transition: all 0.3s ease;
    }
    .comment-wrapper:hover {
        border-left-color: #e4e6eb;
    }
    .comment-bubble {
        background: #f0f2f5;
        border-radius: 18px;
        padding: 8px 12px;
        display: inline-block;
        max-width: 100%;
        word-wrap: break-word;
    }
    .fade-in {
        animation: fadeIn 0.5s forwards;
        opacity: 0;
    }
    @keyframes fadeIn {
        to { opacity: 1; }
    }
    .fade-out {
        animation: fadeOut 0.5s forwards;
    }
    @keyframes fadeOut {
        to { opacity: 0; transform: scale(0.95); }
    }
</style>
{% endblock %}

{% block posts_content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        
        <!-- Post Card -->
        {% include 'posts/includes/post_card.html' %}

        <!-- Comments Section -->
        <div class="card mt-3 border-0 shadow-sm">
            <div class="card-header bg-white border-bottom">
                <div class="d-flex justify-content-between align-items-center">
                    <strong><i class="fas fa-comments me-2"></i>B√¨nh lu·∫≠n (<span id="total-comments">{{ total_comments }}</span>)</strong>
                    {% if post.author == request.user %}
                        <button class="btn btn-sm btn-outline-secondary" onclick="alert('C√†i ƒë·∫∑t')">
                            <i class="fas fa-cog"></i> C√†i ƒë·∫∑t
                        </button>
                    {% endif %}
                </div>
            </div>
            
            <div class="card-body">
                <!-- Comment Input -->
                <div class="d-flex gap-2 mb-4">
                    <img src="{{ request.user.userprofile.avatar.url|default:'https://ui-avatars.com/api/?name='|add:request.user.username }}" 
                         class="rounded-circle" width="36" height="36">
                    <form onsubmit="event.preventDefault(); submitComment({{ post.id }});" class="flex-grow-1">
                        <div class="input-group">
                            <input id="main-comment-input" 
                                   class="form-control rounded-pill bg-light border-0" 
                                   placeholder="Vi·∫øt b√¨nh lu·∫≠n..."
                                   autocomplete="off">
                            <button type="submit" class="btn btn-link">
                                <i class="fas fa-paper-plane text-primary"></i>
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Comments List -->
                <div id="comments-list">
                    {% for comment in comments %}
                        <div class="comment-wrapper fade-in" 
                             id="comment-{{ comment.id }}" 
                             style="margin-left: {{ comment.index_px }}px;">
                            <div class="d-flex gap-2">
                                <img src="https://ui-avatars.com/api/?name={{ comment.user.username }}" 
                                     class="rounded-circle" width="36" height="36">
                                <div class="flex-grow-1">
                                    <div class="comment-bubble">
                                        <div class="fw-bold small mb-1">{{ comment.user.username }}</div>
                                        <div class="text-body" id="comment-content-{{ comment.id }}">{{ comment.content }}</div>
                                    </div>
                                    
                                    <!-- Comment Actions -->
                                    <div class="small mt-1 text-muted d-flex gap-3 ps-2">
                                        <span class="text-muted" style="font-size: 11px;">V·ª´a xong</span>
                                        
                                        <a href="#" 
                                           onclick="toggleCommentLike({{ comment.id }}); return false;" 
                                           class="text-decoration-none {% if comment.user_reaction %}text-primary fw-bold{% else %}text-muted{% endif %}"
                                           id="comment-like-{{ comment.id }}">
                                            Th√≠ch (<span id="clike-{{ comment.id }}">{{ comment.reaction_count }}</span>)
                                        </a>
                                        
                                        {% if comment.level < 7 %}
                                        <a href="#" 
                                           onclick="showReply({{ comment.id }}); return false;" 
                                           class="text-decoration-none text-muted">
                                            Tr·∫£ l·ªùi
                                        </a>
                                        {% endif %}
                                        
                                        {% if request.user == comment.user or request.user == post.author %}
                                            <a href="#" 
                                               onclick="deleteComment({{ comment.id }}); return false;" 
                                               class="text-danger text-decoration-none">
                                                X√≥a
                                            </a>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Reply Input (Hidden by default) -->
                                    <div id="reply-box-{{ comment.id }}" class="mt-2 d-none">
                                        <div class="input-group input-group-sm">
                                            <!-- <input class="form-control rounded-pill" 
                                                   placeholder="Tr·∫£ l·ªùi {{ comment.user.username }}..." 
                                                   onkeydown="if(event.key==='Enter') submitComment({{ comment.id }}, this)"> -->
                                            <input type="text" id="reply-input-{{ comment.id }}" 
                                                   class="form-control form-control-sm rounded-pill bg-light" 
                                                   placeholder="Tr·∫£ l·ªùi {{ comment.user.username }}..."
                                                   onkeydown="if(event.key === 'Enter') submitComment({{ post.id }}, {{ comment.id }})">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% empty %}
                        <div class="text-center text-muted py-4" id="no-comments">
                            <i class="fas fa-comment-slash fa-2x mb-2"></i>
                            <p>Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!</p>
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

<!-- {% block posts_scripts %}
<script>
    const POST_ID = "{{ post.id }}";
    const CURRENT_USER = "{{ request.user.username }}";
    const CURRENT_USER_AVATAR = "{{ request.user.userprofile.avatar.url|default:'https://ui-avatars.com/api/?name='|add:request.user.username }}";

    // ========================================
    // WEBSOCKET CONNECTION FOR POST
    // ========================================
    const wsProto = window.location.protocol === "https:" ? "wss" : "ws";
    const socket = new WebSocket(`${wsProto}://${window.location.host}/ws/post/${POST_ID}/`);

    socket.onopen = function(e) {
        console.log('‚úÖ Post WebSocket connected');
    };

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log('üì® Post event:', data);
        handleRealtimeEvent(data);
    };

    socket.onerror = function(e) {
        console.error('‚ùå Post WebSocket error:', e);
    };

    socket.onclose = function(e) {
        console.log('üîå Post WebSocket closed');
    };

    // ========================================
    // REALTIME EVENT HANDLERS
    // ========================================
    function handleRealtimeEvent(data) {
        switch(data.event) {
            case 'reaction':
                updatePostReaction(data);
                break;
            case 'comment_new':
                appendComment(data);
                break;
            case 'comment_reaction':
                updateCommentReaction(data);
                break;
            case 'comment_deleted':
                removeComment(data.comment_id);
                break;
            case 'comment_updated':
                updateCommentContent(data.comment_id, data.content);
                break;
        }
    }

    function updatePostReaction(data) {
        const countEl = document.getElementById(`reaction-count-${POST_ID}`);
        if (countEl) {
            countEl.innerText = data.total_count;
        }
    }

    function appendComment(data) {
        const noComments = document.getElementById('no-comments');
        if (noComments) noComments.remove();
        
        const indent = (data.level - 1) * 20;
        const isOwn = data.user === CURRENT_USER;
        
        const html = `
        <div class="comment-wrapper fade-in" id="comment-${data.comment_id}" style="margin-left: ${indent}px;">
            <div class="d-flex gap-2">
                <img src="${data.avatar}" class="rounded-circle" width="36" height="36">
                <div class="flex-grow-1">
                    <div class="comment-bubble">
                        <div class="fw-bold small mb-1">${escapeHtml(data.user)}</div>
                        <div class="text-body" id="comment-content-${data.comment_id}">${escapeHtml(data.content)}</div>
                    </div>
                    <div class="small mt-1 text-muted d-flex gap-3 ps-2">
                        <span class="text-muted" style="font-size: 11px;">V·ª´a xong</span>
                        <a href="#" onclick="toggleCommentLike(${data.comment_id}); return false;" 
                           class="text-decoration-none text-muted" id="comment-like-${data.comment_id}">
                            Th√≠ch (<span id="clike-${data.comment_id}">0</span>)
                        </a>
                        ${data.level < 7 ? `<a href="#" onclick="showReply(${data.comment_id}); return false;" class="text-decoration-none text-muted">Tr·∫£ l·ªùi</a>` : ''}
                        ${isOwn ? `<a href="#" onclick="deleteComment(${data.comment_id}); return false;" class="text-danger text-decoration-none">X√≥a</a>` : ''}
                    </div>
                    <div id="reply-box-${data.comment_id}" class="mt-2 d-none">
                        <div class="input-group input-group-sm">
                            <input class="form-control rounded-pill" placeholder="Tr·∫£ l·ªùi ${escapeHtml(data.user)}..." 
                                   onkeydown="if(event.key==='Enter') submitComment(${data.comment_id}, this)">
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
        
        if (data.parent_id) {
            const parent = document.getElementById(`comment-${data.parent_id}`);
            if (parent) {
                parent.insertAdjacentHTML('afterend', html);
            }
        } else {
            document.getElementById('comments-list').insertAdjacentHTML('beforeend', html);
        }
        
        updateTotalComments(1);
    }

    function updateCommentReaction(data) {
        const el = document.getElementById(`clike-${data.comment_id}`);
        if (el) {
            el.innerText = data.count;
        }
    }

    function removeComment(commentId) {
        const el = document.getElementById(`comment-${commentId}`);
        if (el) {
            el.classList.add('fade-out');
            setTimeout(() => {
                el.remove();
                updateTotalComments(-1);
            }, 500);
        }
    }

    function updateCommentContent(commentId, content) {
        const el = document.getElementById(`comment-content-${commentId}`);
        if (el) {
            el.innerText = content;
        }
    }

    function updateTotalComments(delta) {
        const el = document.getElementById('total-comments');
        if (el) {
            const current = parseInt(el.innerText) || 0;
            el.innerText = Math.max(0, current + delta);
        }
    }
</script>
{% endblock %} -->

{% block scripts %}
<script>
    // --- 1. CSRF TOKEN HELPER (B·∫ÆT BU·ªòC ƒê·ªÇ T∆Ø∆†NG T√ÅC) ---
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    // Ensure csrftoken is declared only once globally
        if (typeof csrftoken === 'undefined') {
            const csrftoken = getCookie('csrftoken'); // Token d√πng cho m·ªçi request
        }

    // --- 2. CONFIGURATION ---
    const POST_ID = "{{ post.id }}";
    const CURRENT_USER = "{{ request.user.username }}";
    const REACTION_CONFIG = {
        'like':  { icon: 'fa-thumbs-up', colorClass: 'text-primary', label: 'Th√≠ch' },
        'love':  { icon: 'fa-heart',     colorClass: 'text-danger',  label: 'Y√™u th√≠ch' },
        'haha':  { icon: 'fa-laugh-squint', colorClass: 'text-warning', label: 'Haha' },
        'wow':   { icon: 'fa-surprise',  colorClass: 'text-warning', label: 'Wow' },
        'sad':   { icon: 'fa-sad-tear',  colorClass: 'text-warning', label: 'Bu·ªìn' },
        'angry': { icon: 'fa-angry',     colorClass: 'text-danger',  label: 'Ph·∫´n n·ªô' }
    };

    // --- 3. WEBSOCKET SETUP ---
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const chatSocket = new WebSocket(
        wsScheme + '://' + window.location.host + '/ws/post/' + POST_ID + '/'
    );

    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        const payload = data.data; // L∆∞u √Ω c·∫•u tr√∫c data

        // N·∫øu g·ª≠i t·ª´ services.py format: { type: "post_event", data: { event: "...", ... } }
        // th√¨ payload s·∫Ω ch·ª©a key "event". Ki·ªÉm tra k·ªπ format t·ª´ services.py c·ªßa b·∫°n.
        // D·ª±a tr√™n services.py t√¥i ƒë∆∞a:
        // message_type="post_event", data={ event: "comment_new", ... }
        
        const eventType = payload.event; // comment_new, reaction, ...

        if (eventType === 'reaction') {
            updatePostReactionUI(payload);
        } else if (eventType === 'comment_reaction') {
            updateCommentReactionUI(payload);
        } else if (eventType === 'comment_new') {
            appendNewComment(payload);
        } else if (eventType === 'comment_deleted') {
            removeCommentUI(payload.comment_id);
        } else if (eventType === 'comment_updated') {
            // Update logic here
        }
    };

    chatSocket.onclose = function(e) { console.error('WS Closed'); };

    // --- 4. UI HANDLERS ---
    
    function appendNewComment(data) {
        const indent = (data.level - 1) * 20;
        const threadLine = data.level > 1 ? `<div class="thread-line"></div>` : '';
        
        let mediaHtml = '';
        if(data.images && data.images.length > 0) {
            mediaHtml += '<div class="mt-2">';
            data.images.forEach(url => {
                mediaHtml += `<img src="${url}" class="rounded-3 border me-1" style="max-height: 120px;">`;
            });
            mediaHtml += '</div>';
        }

        let actionsHtml = `
            <span class="text-muted fw-normal">V·ª´a xong</span>
            <a href="#" id="btn-comment-like-${data.comment_id || data.id}" class="text-decoration-none text-muted" onclick="toggleCommentReaction(${data.comment_id || data.id}); return false;">Th√≠ch</a>
            <a href="#" class="text-muted text-decoration-none" onclick="showReplyForm(${data.comment_id || data.id}); return false;">Ph·∫£n h·ªìi</a>
        `;
        
        if (data.user === CURRENT_USER) {
            actionsHtml += `<a href="#" class="text-danger text-decoration-none" onclick="deleteComment(${data.comment_id || data.id}); return false;">X√≥a</a>`;
        }

        const cid = data.comment_id || data.id;

        const html = `
        <div class="comment-wrapper fade-in" id="comment-${cid}" style="padding-left: ${indent}px;">
            <div class="d-flex position-relative">
                ${threadLine}
                <div class="flex-shrink-0 me-2" style="z-index: 1;">
                    <img src="https://ui-avatars.com/api/?name=${data.user}&background=random" class="comment-avatar">
                </div>
                <div class="flex-grow-1">
                    <div class="comment-bubble">
                        <div class="fw-bold text-dark small">${data.user}</div>
                        <div class="text-body small" style="white-space: pre-wrap;">${data.content}</div>
                        ${mediaHtml}
                        <div class="reaction-badge" id="comment-badge-${cid}" style="display: none !important;">
                            <i class="fas fa-thumbs-up text-primary" style="font-size: 10px;"></i>
                            <span id="comment-count-${cid}">0</span>
                        </div>
                    </div>
                    <div class="d-flex gap-3 ms-2 mt-1" style="font-size: 12px; font-weight: 600;">
                        ${actionsHtml}
                    </div>
                    <div id="reply-form-${cid}" class="mt-2 d-none fade-in">
                        <div class="d-flex align-items-center gap-2">
                             <img src="https://ui-avatars.com/api/?name=${CURRENT_USER}" class="rounded-circle" width="24">
                             <div class="flex-grow-1 position-relative">
                                <input type="text" id="reply-input-${cid}" class="form-control form-control-sm rounded-pill bg-light" 
                                    placeholder="Tr·∫£ l·ªùi..." onkeydown="if(event.key === 'Enter') submitComment(${cid})">
                             </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;

        if (data.parent_id) {
            const parent = document.getElementById(`comment-${data.parent_id}`);
            if (parent) parent.insertAdjacentHTML('afterend', html);
        } else {
            document.getElementById('comments-list').insertAdjacentHTML('beforeend', html);
        }
        updateTotalCount(1);
    }

    function updatePostReactionUI(data) {
        const countSpan = document.getElementById(`reaction-count-${data.post_id || POST_ID}`);
        if(countSpan) countSpan.innerText = data.total_count;

        if (data.user === CURRENT_USER) {
            const btn = document.getElementById(`btn-post-like-${data.post_id || POST_ID}`);
            const txt = document.getElementById(`text-post-like-${data.post_id || POST_ID}`);
            if(btn && txt) updateBtnVisual(btn, txt, data.reaction_type, data.status !== 'removed');
        }
    }

    function updateCommentReactionUI(data) {
        const countSpan = document.getElementById(`comment-count-${data.comment_id}`);
        const badge = document.getElementById(`comment-badge-${data.comment_id}`);
        
        if(countSpan) countSpan.innerText = data.count;
        if(badge) badge.style.display = data.count > 0 ? 'flex' : 'none';

        if (data.user === CURRENT_USER) {
            const btn = document.getElementById(`btn-comment-like-${data.comment_id}`);
            if(btn) {
                if (data.status === 'removed') {
                    btn.className = "text-decoration-none text-muted";
                    btn.innerText = "Th√≠ch";
                } else {
                    const cfg = REACTION_CONFIG[data.reaction_type] || REACTION_CONFIG['like'];
                    btn.className = `text-decoration-none fw-bold ${cfg.colorClass}`;
                    btn.innerText = cfg.label;
                }
            }
        }
    }

    function removeCommentUI(id) {
        const el = document.getElementById(`comment-${id}`);
        if(el) {
            el.style.opacity = '0';
            setTimeout(() => el.remove(), 300);
            updateTotalCount(-1);
        }
    }

    // --- 5. ACTIONS (FETCH WITH CSRF) ---

    // --- S·ª¨A L·∫†I H√ÄM N√ÄY ---
function submitComment(postId, parentId = null) {
    // T·∫°o ID ƒë·ªông d·ª±a tr√™n postId ƒë·ªÉ tr√°nh tr√πng l·∫∑p
    const inputId = parentId ? `reply-input-${parentId}` : 'main-comment-input';
    
    const contentInput = document.getElementById(inputId);
    if (!contentInput) return; // Kh√¥ng t√¨m th·∫•y input th√¨ d·ª´ng

    const content = contentInput.value.trim();
    const filesInput = document.getElementById('comment-files');

    if (!content && (!filesInput || filesInput.files.length === 0)) return;

    let formData = new FormData();
    formData.append('content', content);
    if (parentId) formData.append('parent_id', parentId);
    
    if (!parentId && filesInput) {
        for (let i = 0; i < filesInput.files.length; i++) {
            formData.append('images', filesInput.files[i]);
        }
    }

    // D√πng postId ƒë∆∞·ª£c truy·ªÅn v√†o thay v√¨ POST_ID to√†n c·ª•c
    fetch(`/posts/${postId}/comment/`, {
        method: 'POST',
        headers: { 'X-CSRFToken': csrftoken },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'ok') {
            contentInput.value = ''; // X√≥a n·ªôi dung input
            
            if (parentId) {
                // ·∫®n form tr·∫£ l·ªùi (Ch√∫ √Ω ID ph·∫£i kh·ªõp v·ªõi HTML)
                const replyForm = document.getElementById(`reply-form-${parentId}`);
                if (replyForm) replyForm.classList.add('d-none');
            } else {
                // Reset file input n·∫øu l√† comment ch√≠nh
                if (filesInput) filesInput.value = '';
                const preview = document.getElementById('main-preview');
                if (preview) preview.innerHTML = '';
            }
        } else {
            alert(data.error || 'C√≥ l·ªói x·∫£y ra');
        }
    })
    .catch(error => console.error("L·ªói:", error));
}

    function toggleCommentReaction(id) {
        fetch(`/posts/comment/${id}/reaction/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `reaction=like`
        });
    }

    function deleteComment(id) {
        if(confirm("X√≥a b√¨nh lu·∫≠n?")) {
            fetch(`/posts/comment/${id}/delete/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrftoken }
            });
        }
    }

    // --- 6. UTILS ---

    function showReplyForm(id) {
        document.querySelectorAll('[id^="reply-form-"]').forEach(el => el.classList.add('d-none'));
        const form = document.getElementById(`reply-form-${id}`);
        form.classList.remove('d-none');
        setTimeout(() => form.querySelector('input').focus(), 100);
    }

    function autoResize(el) {
        el.style.height = 'auto';
        el.style.height = el.scrollHeight + 'px';
    }

    function previewFiles(input, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = '';
        Array.from(input.files).forEach(file => {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'rounded border';
                img.style.height = '60px';
                container.appendChild(img);
            }
            reader.readAsDataURL(file);
        });
    }

    function updateTotalCount(delta) {
        const label = document.getElementById('total-comments-label');
        if(label) {
            const current = parseInt(label.innerText);
            if(!isNaN(current)) label.innerText = (current + delta) + " b√¨nh lu·∫≠n";
        }
    }

    function updateBtnVisual(btn, txt, type, isActive) {
        btn.className = "btn w-100 action-btn"; 
        const icon = btn.querySelector('i');
        icon.className = "me-2"; 
        
        if(isActive) {
            const cfg = REACTION_CONFIG[type] || REACTION_CONFIG['like'];
            btn.classList.add('fw-bold', cfg.colorClass); 
            icon.classList.add('fas', cfg.icon);
            txt.innerText = cfg.label;
        } else {
            icon.classList.add('far', 'fa-thumbs-up');
            txt.innerText = "Th√≠ch";
        }
    }
    
    // Global function for Post Card (Post Like)
    window.toggleReaction = function(postId, type) {
        fetch(`/posts/${postId}/reaction/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `reaction=${type}`
        });
    };
</script>
<script>
    // ========================================
    // GLOBAL JAVASCRIPT FOR POSTS
    // ========================================
    
    // 1. CSRF TOKEN HELPER
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    // 2. REACTION FUNCTIONS
    let reactionTimeout;
    
    function delayShowReactions(postId) {
        clearTimeout(reactionTimeout);
        reactionTimeout = setTimeout(() => {
            const picker = document.getElementById(`reaction-picker-${postId}`);
            if (picker) picker.style.display = 'block';
        }, 500);
    }
    
    function hideReactions(postId) {
        clearTimeout(reactionTimeout);
        setTimeout(() => {
            const picker = document.getElementById(`reaction-picker-${postId}`);
            if (picker) picker.style.display = 'none';
        }, 300);
    }
    
    function showReactionPicker(postId) {
        const picker = document.getElementById(`reaction-picker-${postId}`);
        if (picker) {
            const isVisible = picker.style.display === 'block';
            document.querySelectorAll('.reaction-picker').forEach(p => p.style.display = 'none');
            picker.style.display = isVisible ? 'none' : 'block';
        }
    }
    
    function toggleReaction(postId, type) {
        type = type || 'like';
        const btn = document.getElementById(`btn-post-like-${postId}`);
        const text = document.getElementById(`text-post-like-${postId}`);
        const countSpan = document.getElementById(`reaction-count-${postId}`);
        
        // Hide picker
        const picker = document.getElementById(`reaction-picker-${postId}`);
        if (picker) picker.style.display = 'none';
        
        fetch(`/posts/${postId}/reaction/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: `reaction=${type}`
        })
        .then(res => {
            if (!res.ok) throw new Error("Network error");
            return res.json();
        })
        .then(data => {
            if (data.status === 'added' || data.status === 'changed') {
                btn.classList.add('reaction-active');
                btn.classList.remove('text-muted');
                const names = {
                    'like': 'Th√≠ch',
                    'love': 'Y√™u th√≠ch',
                    'haha': 'Haha',
                    'sad': 'Bu·ªìn',
                    'angry': 'Ph·∫´n n·ªô'
                };
                text.innerText = names[type] || 'Th√≠ch';
            } else {
                btn.classList.remove('reaction-active');
                btn.classList.add('text-muted');
                text.innerText = "Th√≠ch";
            }
            if (countSpan && data.total_count !== undefined) {
                countSpan.innerText = data.total_count;
            }
        })
        .catch(err => {
            console.error('Reaction error:', err);
            alert('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.');
        });
    }

    // 3. POST ACTIONS
    function sharePost(postId) {
        const caption = prompt("Vi·∫øt l·ªùi nh·∫Øn khi chia s·∫ª (t√πy ch·ªçn):");
        if (caption !== null) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/posts/${postId}/share/`;
            
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrftoken;
            
            const captionInput = document.createElement('input');
            captionInput.type = 'hidden';
            captionInput.name = 'caption';
            captionInput.value = caption;
            
            form.appendChild(csrfInput);
            form.appendChild(captionInput);
            document.body.appendChild(form);
            form.submit();
        }
    }
    
    function deletePost(postId) {
        if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√†i vi·∫øt n√†y?")) {
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/posts/${postId}/delete/`;
            
            const csrfInput = document.createElement('input');
            csrfInput.type = 'hidden';
            csrfInput.name = 'csrfmiddlewaretoken';
            csrfInput.value = csrftoken;
            
            form.appendChild(csrfInput);
            document.body.appendChild(form);
            form.submit();
        }
    }

    // 4. COMMENT FUNCTIONS
    function submitComment(parentId, inputEl) {
        if (typeof POST_ID === 'undefined') {
            console.error('POST_ID is not defined');
            return;
        }
        
        const el = inputEl || document.getElementById('main-comment-input');
        if (!el) {
            console.error('Comment input not found');
            return;
        }
        
        const content = el.value.trim();
        if (!content) {
            alert('Vui l√≤ng nh·∫≠p n·ªôi dung b√¨nh lu·∫≠n');
            return;
        }

        const formData = new FormData();
        formData.append('content', content);
        if (parentId) formData.append('parent_id', parentId);

        fetch(`/posts/${POST_ID}/comment/`, {
            method: 'POST',
            headers: {'X-CSRFToken': csrftoken},
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'ok') {
                el.value = '';
                if (parentId) {
                    const replyBox = document.getElementById(`reply-box-${parentId}`);
                    if (replyBox) replyBox.classList.add('d-none');
                }
            } else {
                alert(data.error || 'C√≥ l·ªói x·∫£y ra');
            }
        })
        .catch(err => {
            console.error('Comment error:', err);
            alert('C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i.');
        });
    }

    function toggleCommentLike(commentId) {
        fetch(`/posts/comment/${commentId}/reaction/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/x-www-form-urlencoded'
            },
            body: 'reaction=like'
        })
        .then(res => res.json())
        .then(data => {
            const linkEl = document.getElementById(`comment-like-${commentId}`);
            if (linkEl) {
                if (data.status === 'added' || data.status === 'changed') {
                    linkEl.classList.add('text-primary', 'fw-bold');
                    linkEl.classList.remove('text-muted');
                } else {
                    linkEl.classList.remove('text-primary', 'fw-bold');
                    linkEl.classList.add('text-muted');
                }
            }
        })
        .catch(err => console.error('Comment reaction error:', err));
    }

    function deleteComment(commentId) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b√¨nh lu·∫≠n n√†y?")) return;
        
        fetch(`/posts/comment/${commentId}/delete/`, {
            method: 'POST',
            headers: {'X-CSRFToken': csrftoken}
        })
        .then(res => res.json())
        .then(data => {
            if (data.status !== 'ok') {
                alert(data.error || 'C√≥ l·ªói x·∫£y ra');
            }
        })
        .catch(err => console.error('Delete comment error:', err));
    }

    function showReply(commentId) {
        const box = document.getElementById(`reply-box-${commentId}`);
        if (box) {
            box.classList.toggle('d-none');
            if (!box.classList.contains('d-none')) {
                const input = box.querySelector('input');
                if (input) input.focus();
            }
        }
    }

    // 5. UTILITY
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // 6. CLOSE PICKERS ON OUTSIDE CLICK
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.reaction-btn') && !e.target.closest('.reaction-picker')) {
            document.querySelectorAll('.reaction-picker').forEach(p => p.style.display = 'none');
        }
    });
    
    console.log('‚úÖ Posts global functions loaded');
</script>
{% endblock %}