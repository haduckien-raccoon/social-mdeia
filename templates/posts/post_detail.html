{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<style>
    /* =========================================
       1. GLOBAL & FACEBOOK VARIABLES
       ========================================= */
    :root {
        --primary: #1877f2;
        --bg-body: #f0f2f5;
        --bg-card: #ffffff;
        --text-main: #050505;
        --text-sub: #65676b;
        --hover-bg: #f2f2f2;
        --divider: #ced0d4;
        --shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        --comment-bg: #f0f2f5;
        --radius: 8px;
    }

    body {
        background-color: var(--bg-body);
        font-family: Segoe UI, Helvetica, Arial, sans-serif;
    }

    .detail-container {
        max-width: 680px;
        margin: 20px auto;
        padding-bottom: 60px;
    }

    /* =========================================
       2. POST CARD STYLING
       ========================================= */
    .fb-card {
        background: var(--bg-card);
        border-radius: var(--radius);
        box-shadow: var(--shadow);
        margin-bottom: 15px;
        overflow: visible;
    }

    /* Header */
    .post-header { padding: 12px 16px; display: flex; align-items: center; }
    .post-avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 10px; cursor: pointer; }
    .post-info h4 { margin: 0; font-size: 15px; font-weight: 600; color: var(--text-main); }
    .post-info h4 a { text-decoration: none; color: inherit; }
    .post-time { font-size: 13px; color: var(--text-sub); display: flex; align-items: center; gap: 4px; }

    /* Content & Share Block */
    .post-content { padding: 4px 16px 16px; font-size: 15px; color: var(--text-main); line-height: 1.5; }
    
    /* STYLE CHO B√ÄI SHARE (SHARED POST) */
    .shared-post-container {
        border: 1px solid #ddd;
        border-radius: 8px;
        margin: 0 16px 16px 16px;
        overflow: hidden;
    }
    .shared-header { padding: 10px; display: flex; align-items: center; background: #f7f8fa; border-bottom: 1px solid #eee; }
    .shared-avatar { width: 32px; height: 32px; border-radius: 50%; margin-right: 8px; }
    .shared-info { font-weight: 600; font-size: 14px; }
    .shared-time { font-size: 12px; color: var(--text-sub); font-weight: normal; }
    .shared-body { padding: 10px; }

    /* Images */
    .post-images { display: grid; gap: 2px; background: #fff; cursor: pointer; overflow: hidden; }
    .post-images img { width: 100%; height: 100%; object-fit: cover; display: block; transition: opacity 0.2s; }
    .grid-1 { grid-template-columns: 1fr; }
    .grid-2 { grid-template-columns: 1fr 1fr; height: 350px; }
    .grid-3 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; height: 400px; }
    .grid-3 img:first-child { grid-row: span 2; }
    .grid-4 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; height: 400px; }

    /* Stats & Actions */
    .post-stats { padding: 10px 16px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--divider); font-size: 14px; color: var(--text-sub); }
    .post-actions { display: flex; padding: 4px 16px; border-bottom: 1px solid var(--divider); position: relative; }
    .action-btn { flex: 1; display: flex; justify-content: center; align-items: center; height: 36px; border-radius: 4px; color: var(--text-sub); font-weight: 600; font-size: 14px; cursor: pointer; transition: 0.2s; background: transparent; border: none; }
    .action-btn:hover { background-color: var(--hover-bg); }
    
    /* REACTION WRAPPER & POPUP (FIXED HOVER) */
    .reaction-wrapper { flex: 1; position: relative; display: flex; }
    .reaction-wrapper::after { content: ''; position: absolute; bottom: 100%; left: 0; width: 100%; height: 20px; display: none; }
    .reaction-wrapper:hover::after { display: block; }
    
    .reaction-popup {
        position: absolute; bottom: 100%; left: 10px; margin-bottom: 5px;
        background: #fff; border-radius: 50px; padding: 6px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.3); display: none; gap: 8px; z-index: 1000;
        animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .reaction-wrapper:hover .reaction-popup { display: flex; }
    .emoji-btn { font-size: 24px; cursor: pointer; transition: transform 0.2s; line-height: 1; }
    .emoji-btn:hover { transform: scale(1.4); }

    /* COMMENT REACTION POPUP */
    .comment-reaction-wrapper { position: relative; display: inline-block; }
    .comment-reaction-wrapper::after { content: ''; position: absolute; bottom: 100%; left: 0; width: 100%; height: 10px; display: none; }
    .comment-reaction-wrapper:hover::after { display: block; }
    
    .comment-popup {
        position: absolute; bottom: 100%; left: -10px; margin-bottom: 5px;
        background: #fff; border-radius: 50px; padding: 4px 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: none; gap: 5px; z-index: 500;
        animation: popUp 0.2s ease-out;
    }
    .comment-reaction-wrapper:hover .comment-popup { display: flex; }
    .emoji-btn-small { font-size: 20px; cursor: pointer; transition: 0.2s; }
    .emoji-btn-small:hover { transform: scale(1.4); }

    /* Active Colors */
    .active-like, .text-like { color: var(--primary) !important; }
    .active-love, .text-love { color: #f33e58 !important; }
    .active-haha, .active-wow, .active-sad, .text-haha, .text-wow, .text-sad { color: #f7b125 !important; }
    .active-angry, .text-angry { color: #e9710f !important; }

    @keyframes popUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* =========================================
       3. COMMENTS UI
       ========================================= */
    .comments-wrapper { padding: 8px 16px; }
    .comment-input-area { display: flex; gap: 8px; margin-bottom: 16px; align-items: flex-start; }
    .my-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
    .input-bubble { flex: 1; background: var(--comment-bg); border-radius: 18px; padding: 8px 12px; display: flex; align-items: center; }
    .input-bubble input { width: 100%; border: none; background: transparent; outline: none; font-size: 14px; }
    .input-actions i { color: var(--text-sub); cursor: pointer; margin-left: 8px; font-size: 16px; }
    
    .comment-item { margin-bottom: 8px; display: flex; gap: 8px; position: relative; }
    .thread-line { position: absolute; left: -12px; top: -10px; width: 20px; height: 35px; border-left: 2px solid #e4e6eb; border-bottom: 2px solid #e4e6eb; border-bottom-left-radius: 12px; }
    .comment-bubble { background: var(--comment-bg); border-radius: 18px; padding: 8px 12px; display: inline-block; max-width: 100%; }
    .comment-author-name { font-weight: 700; font-size: 13px; color: var(--text-main); text-decoration: none; }
    .comment-text-content { font-size: 14px; line-height: 1.4; word-wrap: break-word; }
    .comment-meta { margin-left: 12px; margin-top: 2px; font-size: 12px; color: var(--text-sub); display: flex; gap: 12px; }
    .meta-action { cursor: pointer; font-weight: 700; text-decoration: none; color: var(--text-sub); }
    .meta-action:hover { text-decoration: underline; }
    .meta-action.delete { color: #dc3545; }
    .cmt-reaction-badge { position: absolute; right: -10px; bottom: -6px; background: #fff; border-radius: 10px; box-shadow: 0 1px 2px rgba(0,0,0,0.2); padding: 2px 4px; display: flex; align-items: center; gap: 3px; }
    .comment-img-preview { max-height: 120px; border-radius: 8px; margin-top: 5px; display: block; }

    /* =========================================
       4. LIGHTBOX & SHARE MODAL
       ========================================= */
    .lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 9999; display: none; justify-content: center; align-items: center; flex-direction: column; }
    .lightbox.active { display: flex; animation: fadeIn 0.2s; }
    .lightbox-content { max-width: 90%; max-height: 85vh; object-fit: contain; transition: opacity 0.15s; }
    .lightbox-close { position: absolute; top: 20px; right: 30px; color: #fff; font-size: 40px; cursor: pointer; z-index: 10001; }
    .lightbox-nav { position: absolute; top: 50%; color: #fff; font-size: 30px; cursor: pointer; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 50%; margin-top: -30px; z-index: 10000; }
    
    .share-modal { position: fixed; inset: 0; background: rgba(255,255,255,0.8); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 2000; }
    .share-box { background: #fff; width: 100%; max-width: 500px; border-radius: 12px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); border: 1px solid #ddd; overflow: hidden; }
    .share-header { padding: 15px; border-bottom: 1px solid #eee; text-align: center; font-weight: 700; font-size: 20px; position: relative; }
    .share-body { padding: 15px; }
    .share-user { display: flex; align-items: center; margin-bottom: 15px; }
    .share-user img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }
    .share-privacy { background: #e4e6eb; border: none; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; }
    .share-caption { width: 100%; border: none; outline: none; font-size: 16px; resize: none; min-height: 80px; margin-bottom: 15px; }
    .share-preview { border: 1px solid #ced0d4; border-radius: 8px; padding: 10px; margin-bottom: 15px; background: #f7f8fa; }
    .share-actions { display: flex; justify-content: flex-end; gap: 10px; }
    .btn-share-submit { background: #0064fb;; color: #fff; border: none; padding: 8px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; }
    .btn-share-cancel { background: #e4e6eb; color: var(--text-main); border: none; padding: 8px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; }

    .fade-in { animation: fadeIn 0.3s; }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
</style>
{% endblock %}

{% block content %}
<div class="detail-container">

    <div class="fb-card" id="post-{{ post.id }}">
        
        <div class="post-header">
            <img src="{{ post.author.userprofile.avatar.url|default:'https://ui-avatars.com/api/?name='|add:post.author.username }}" class="post-avatar">
            <div class="post-info">
                <h4><a href="#">{{ post.author.username }}</a></h4>
                <div class="post-time">
                    <span>{{ post.created_at|timesince }} tr∆∞·ªõc</span> ‚Ä¢ 
                    {% if post.privacy == 'public' %}<i class="fas fa-globe-americas"></i>
                    {% elif post.privacy == 'friends' %}<i class="fas fa-user-friends"></i>
                    {% else %}<i class="fas fa-lock"></i>{% endif %}
                </div>
            </div>
            {% if request.user == post.author %}
            <div style="margin-left: auto;">
                <a href="{% url 'posts:edit_post' post.id %}" class="btn btn-sm btn-light rounded-circle"><i class="fas fa-pen"></i></a>
                <a href="#" onclick="if(confirm('X√≥a b√†i?')) document.getElementById('del-post').submit()" class="btn btn-sm btn-light rounded-circle"><i class="fas fa-trash"></i></a>
                <form id="del-post" action="{% url 'posts:delete_post' post.id %}" method="POST" hidden>{% csrf_token %}</form>
            </div>
            {% endif %}
        </div>

        <div class="post-content">{{ post.content|linebreaksbr }}</div>

        {% if post.postshare %}
        <div class="shared-post-container">
            <div class="shared-header">
                <img src="{{ post.postshare.original_post.author.userprofile.avatar.url|default:'https://ui-avatars.com/api/?name='|add:post.postshare.original_post.author.username }}" class="shared-avatar">
                <div>
                    <div class="shared-info">{{ post.postshare.original_post.author.username }}</div>
                    <div class="shared-time">{{ post.postshare.original_post.created_at|timesince }} tr∆∞·ªõc</div>
                </div>
            </div>
            <div class="shared-body">
                <div style="margin-bottom: 10px;">{{ post.postshare.original_post.content|linebreaksbr }}</div>
                
                {% if post.postshare.original_post.images.all %}
                <div class="post-images grid-{{ post.postshare.original_post.images.count|default:1 }}">
                    {% for img in post.postshare.original_post.images.all|slice:":4" %}
                        <img src="{{ img.image.url }}" onclick="openLightbox({{ forloop.counter0 }}, true)"> {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

        {% if post.images.all and not post.postshare %}
            <div class="post-images grid-{{ post.images.count|default:1 }}">
                {% for img in post.images.all|slice:":4" %}
                    <img src="{{ img.image.url }}" onclick="openLightbox({{ forloop.counter0 }})">
                {% endfor %}
            </div>
        {% endif %}

        <div class="post-stats">
            <div class="reaction-count">
                {% if total_reactions > 0 %}
                    <i class="fas fa-thumbs-up text-primary"></i> <span id="post-reaction-count">{{ total_reactions }}</span>
                {% else %}
                    <span>H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n th√≠ch b√†i n√†y</span>
                {% endif %}
            </div>
            <div class="comment-count"><span id="total-comments-label">{{ total_comments }}</span> b√¨nh lu·∫≠n</div>
        </div>

        <div class="post-actions">
            <div class="reaction-wrapper">
                <div class="reaction-popup">
                    <span class="emoji-btn" onclick="submitPostReaction('like')">üëç</span>
                    <span class="emoji-btn" onclick="submitPostReaction('love')">‚ù§Ô∏è</span>
                    <span class="emoji-btn" onclick="submitPostReaction('haha')">üòÜ</span>
                    <span class="emoji-btn" onclick="submitPostReaction('wow')">üòÆ</span>
                    <span class="emoji-btn" onclick="submitPostReaction('sad')">üò¢</span>
                    <span class="emoji-btn" onclick="submitPostReaction('angry')">üò°</span>
                </div>
                <button class="action-btn {% if post.current_user_reaction %}active-{{ post.current_user_reaction }}{% endif %}" 
                        id="main-like-btn" onclick="submitPostReaction('like')" style="width: 100%;">
                    {% if post.current_user_reaction == 'like' %} <i class="fas fa-thumbs-up"></i> Th√≠ch
                    {% elif post.current_user_reaction == 'love' %} <i class="fas fa-heart"></i> Y√™u th√≠ch
                    {% elif post.current_user_reaction == 'haha' %} <i class="fas fa-laugh-squint"></i> Haha
                    {% elif post.current_user_reaction == 'sad' %} <i class="fas fa-sad-tear"></i> Bu·ªìn
                    {% elif post.current_user_reaction == 'wow' %} <i class="fas fa-surprise"></i> Wow
                    {% elif post.current_user_reaction == 'angry' %} <i class="fas fa-angry"></i> Ph·∫´n n·ªô
                    {% else %} <i class="far fa-thumbs-up"></i> Th√≠ch
                    {% endif %}
                </button>
            </div>
            <button class="action-btn" onclick="document.getElementById('main-comment-input').focus()"><i class="far fa-comment-alt"></i> B√¨nh lu·∫≠n</button>
            <button class="action-btn" onclick="openShareModal()"><i class="fas fa-share"></i> Chia s·∫ª</button>
        </div>

        <div class="comments-wrapper">
            <div class="comment-input-area">
                <img src="{{ request.user.userprofile.avatar.url|default:'https://ui-avatars.com/api/?name='|add:request.user.username }}" class="my-avatar">
                <div class="input-bubble">
                    <input type="text" id="main-comment-input" placeholder="Vi·∫øt b√¨nh lu·∫≠n..." autocomplete="off" onkeydown="if(event.key === 'Enter') submitComment({{ post.id }})">
                    <div class="input-actions">
                        <label for="comment-files" style="margin:0"><i class="fas fa-camera"></i></label>
                        <i class="fas fa-paper-plane text-primary" onclick="submitComment({{ post.id }})"></i>
                    </div>
                    <input type="file" id="comment-files" hidden multiple accept="image/*">
                </div>
            </div>
            <div id="main-preview" style="padding-left: 40px; margin-bottom: 10px;"></div>

            <div id="comments-list">
                {% for comment in comments %}
                    <div class="comment-item fade-in" id="comment-{{ comment.id }}" style="padding-left: {{ comment.index_px }}px;">
                        <div class="d-flex position-relative w-100">
                            {% if comment.level > 1 %}<div class="thread-line"></div>{% endif %}
                            <img src="https://ui-avatars.com/api/?name={{ comment.user.username }}" class="my-avatar" style="margin-right: 8px;">
                            <div style="flex: 1;">
                                <div class="comment-bubble">
                                    <a href="#" class="comment-author-name">{{ comment.user.username }}</a>
                                    <div class="comment-text-content">{{ comment.content }}</div>
                                    {% if comment.images.all %}
                                        {% for img in comment.images.all %}<img src="{{ img.image.url }}" class="comment-img-preview">{% endfor %}
                                    {% endif %}
                                    <div class="cmt-reaction-badge" id="comment-badge-{{ comment.id }}" 
                                         style="display: {% if comment.likes_count > 0 %}flex{% else %}none{% endif %} !important;">
                                        <i class="fas fa-thumbs-up"></i><span id="comment-count-{{ comment.id }}">{{ comment.likes_count }}</span>
                                    </div>
                                </div>
                                <div class="comment-meta">
                                    <span>{{ comment.created_at|timesince }}</span>
                                    
                                    <div class="comment-reaction-wrapper">
                                        <div class="comment-popup">
                                            <span class="emoji-btn-small" onclick="submitCommentReaction({{ comment.id }}, 'like')">üëç</span>
                                            <span class="emoji-btn-small" onclick="submitCommentReaction({{ comment.id }}, 'love')">‚ù§Ô∏è</span>
                                            <span class="emoji-btn-small" onclick="submitCommentReaction({{ comment.id }}, 'haha')">üòÜ</span>
                                            <span class="emoji-btn-small" onclick="submitCommentReaction({{ comment.id }}, 'wow')">üòÆ</span>
                                            <span class="emoji-btn-small" onclick="submitCommentReaction({{ comment.id }}, 'sad')">üò¢</span>
                                            <span class="emoji-btn-small" onclick="submitCommentReaction({{ comment.id }}, 'angry')">üò°</span>
                                        </div>
                                        <a href="#" onclick="submitCommentReaction({{ comment.id }}, 'like'); return false;" 
                                           class="meta-action {% if comment.current_reaction %}text-{{ comment.current_reaction }}{% endif %}"
                                           id="btn-comment-txt-{{ comment.id }}">
                                           {% if comment.current_reaction == 'like' %}Th√≠ch
                                           {% elif comment.current_reaction == 'love' %}Y√™u th√≠ch
                                           {% elif comment.current_reaction == 'haha' %}Haha
                                           {% elif comment.current_reaction == 'wow' %}Wow
                                           {% elif comment.current_reaction == 'sad' %}Bu·ªìn
                                           {% elif comment.current_reaction == 'angry' %}Ph·∫´n n·ªô
                                           {% else %}Th√≠ch{% endif %}
                                        </a>
                                    </div>

                                    <a href="#" onclick="showReplyForm({{ comment.id }}); return false;" class="meta-action">Ph·∫£n h·ªìi</a>
                                    {% if request.user == comment.user or request.user == post.author %}
                                    <a href="#" onclick="deleteComment({{ comment.id }}); return false;" class="meta-action delete">X√≥a</a>
                                    {% endif %}
                                </div>
                                <div id="reply-form-{{ comment.id }}" class="mt-2 d-none fade-in">
                                    <div class="d-flex align-items-center gap-2">
                                         <img src="https://ui-avatars.com/api/?name={{ request.user.username }}" class="my-avatar" style="width: 24px; height: 24px;">
                                         <div class="input-bubble" style="padding: 4px 10px;">
                                            <input type="text" id="reply-input-{{ comment.id }}" placeholder="Tr·∫£ l·ªùi..." 
                                                   onkeydown="if(event.key === 'Enter') submitComment({{ post.id }}, {{ comment.id }})">
                                         </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="text-center p-4 text-muted" id="no-comments">Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.</div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div id="shareModal" class="share-modal" onclick="closeShareModal(event)">
    <div class="share-box">
        <div class="share-header">
            Chia s·∫ª b√†i vi·∫øt
            <span class="close-btn" onclick="closeShareModal()" style="right: 10px; width: 30px; height: 30px; font-size: 20px; position:absolute; cursor:pointer;">&times;</span>
        </div>
        <form action="{% url 'posts:share_post' post.id %}" method="POST" class="share-body">
            {% csrf_token %}
            <div class="share-user">
                <img src="{{ request.user.userprofile.avatar.url|default:'https://ui-avatars.com/api/?name='|add:request.user.username }}">
                <div>
                    <div style="font-weight: 600;">{{ request.user.username }}</div>
                    <select name="privacy" class="share-privacy">
                        <option value="public">üåç C√¥ng khai</option>
                        <option value="friends">üë• B·∫°n b√®</option>
                        <option value="only_me">üîí Ch·ªâ m√¨nh t√¥i</option>
                    </select>
                </div>
            </div>
            <textarea name="caption" class="share-caption" placeholder="H√£y n√≥i g√¨ ƒë√≥ v·ªÅ n·ªôi dung n√†y..."></textarea>
            <div class="share-preview">
                <div class="share-preview-info">B√†i vi·∫øt c·ªßa {{ post.author.username }}</div>
                <div class="share-preview-content">
                    {% if post.postshare %}
                        {{ post.postshare.original_post.content|truncatechars:100 }}
                    {% else %}
                        {{ post.content|truncatechars:100 }}
                    {% endif %}
                </div>
            </div>
            <div class="share-actions">
                <button type="button" class="btn-share-cancel" onclick="closeShareModal()">H·ªßy</button>
                <button type="submit" class="btn-share-submit">Chia s·∫ª ngay</button>
            </div>
        </form>
    </div>
</div>

<div id="lightbox" class="lightbox" onclick="closeLightbox(event)">
    <span class="lightbox-close" onclick="closeLightbox(event)">&times;</span>
    <div class="nav-prev lightbox-nav" onclick="changeImg(-1, event)">&#10094;</div>
    <div class="nav-next lightbox-nav" onclick="changeImg(1, event)">&#10095;</div>
    <img id="lightbox-img" class="lightbox-content" src="" onclick="event.stopPropagation()">
    <div class="lightbox-counter" id="lightbox-counter"></div>
</div>

<script>
    // DATA IMAGES (X·ª≠ l√Ω c·∫£ b√†i th∆∞·ªùng v√† b√†i share)
    const ALL_POST_IMAGES = [
        {% if post.postshare %}
            {% for img in post.postshare.original_post.images.all %}"{{ img.image.url }}",{% endfor %}
        {% else %}
            {% for img in post.images.all %}"{{ img.image.url }}",{% endfor %}
        {% endif %}
    ];

    const POST_ID = "{{ post.id }}";
    const CURRENT_USER = "{{ request.user.username }}";
    
    const getCookie = (name) => {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };
    const csrftoken = getCookie('csrftoken');

    // --- REACTION FUNCTIONS ---
    function updatePostReactionUI(type) {
        const btn = document.getElementById('main-like-btn');
        btn.className = 'action-btn'; 
        if (!type) {
            btn.innerHTML = '<i class="far fa-thumbs-up"></i> Th√≠ch';
        } else {
            btn.classList.add(`active-${type}`);
            const map = { 'like':'Th√≠ch', 'love':'Y√™u th√≠ch', 'haha':'Haha', 'wow':'Wow', 'sad':'Bu·ªìn', 'angry':'Ph·∫´n n·ªô' };
            const icons = { 'like':'thumbs-up', 'love':'heart', 'haha':'laugh-squint', 'wow':'surprise', 'sad':'sad-tear', 'angry':'angry' };
            btn.innerHTML = `<i class="fas fa-${icons[type]}"></i> ${map[type]}`;
        }
    }

    function submitPostReaction(type) {
        fetch(`/posts/${POST_ID}/reaction/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `reaction=${type}`
        }).then(res => res.json()).then(data => {
            updatePostReactionUI(data.status === 'removed' ? null : type);
            document.getElementById('post-reaction-count').innerText = data.total_count;
        });
    }

    // --- FIX: COMMENT REACTION LOGIC ---
    function submitCommentReaction(commentId, type) {
        // G·ª≠i request
        fetch(`/posts/comment/${commentId}/reaction/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `reaction=${type}`
        }).then(res => res.json()).then(data => {
            // C·∫≠p nh·∫≠t UI ngay l·∫≠p t·ª©c (d·ª±a v√†o response t·ª´ server)
            updateCommentReactionUI(commentId, data.status === 'removed' ? null : type, data.count);
        });
    }

    function updateCommentReactionUI(commentId, type, count) {
        // 1. Update Text Color & Content
        const btnText = document.getElementById(`btn-comment-txt-${commentId}`);
        if(btnText) {
            btnText.className = 'meta-action'; // Reset
            const map = { 'like':'Th√≠ch', 'love':'Y√™u th√≠ch', 'haha':'Haha', 'wow':'Wow', 'sad':'Bu·ªìn', 'angry':'Ph·∫´n n·ªô' };
            if(!type) {
                btnText.innerText = 'Th√≠ch';
            } else {
                btnText.classList.add(`text-${type}`);
                btnText.innerText = map[type];
            }
        }
        // 2. Update Count & Icon Badge
        const badge = document.getElementById(`comment-badge-${commentId}`);
        const countSpan = document.getElementById(`comment-count-${commentId}`);
        if(countSpan) countSpan.innerText = count;
        if(badge) badge.style.display = count > 0 ? 'flex' : 'none';
    }

    // --- SHARE MODAL ---
    function openShareModal() {
        document.getElementById('shareModal').style.display = 'flex';
        document.querySelector('.share-caption').focus();
    }
    function closeShareModal(e) {
        if (!e || e.target.id === 'shareModal' || e.target.classList.contains('close-btn') || e.target.classList.contains('btn-share-cancel')) {
            document.getElementById('shareModal').style.display = 'none';
        }
    }

    // --- COMMENT CRUD & WEBSOCKET (GI·ªÆ NGUY√äN) ---
    window.submitComment = function(postId, parentId = null) {
        const inputId = parentId ? `reply-input-${parentId}` : 'main-comment-input';
        const input = document.getElementById(inputId);
        const content = input.value.trim();
        const fileInput = document.getElementById('comment-files');
        if (!content && (!fileInput || fileInput.files.length === 0)) return;
        let formData = new FormData();
        formData.append('content', content);
        if (parentId) formData.append('parent_id', parentId);
        if (!parentId && fileInput && fileInput.files.length > 0) {
            for (let i = 0; i < fileInput.files.length; i++) formData.append('images', fileInput.files[i]);
        }
        fetch(`/posts/${postId}/comment/`, {
            method: 'POST', headers: { 'X-CSRFToken': csrftoken }, body: formData
        }).then(res => res.json()).then(data => {
            if(data.status === 'ok') {
                input.value = '';
                if(parentId) document.getElementById(`reply-form-${parentId}`).classList.add('d-none');
                else { document.getElementById('main-preview').innerHTML = ''; fileInput.value = ''; }
            }
        });
    };

    window.deleteComment = function(id) {
        if(confirm("X√≥a b√¨nh lu·∫≠n?")) fetch(`/posts/comment/${id}/delete/`, { method: 'POST', headers: { 'X-CSRFToken': csrftoken } });
    };

    window.showReplyForm = function(id) {
        document.querySelectorAll('[id^="reply-form-"]').forEach(el => el.classList.add('d-none'));
        const form = document.getElementById(`reply-form-${id}`);
        form.classList.remove('d-none');
        setTimeout(() => form.querySelector('input').focus(), 100);
    };

    // WEBSOCKET
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const chatSocket = new WebSocket(wsScheme + '://' + window.location.host + '/ws/post/' + POST_ID + '/');
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data).data;
        if (data.event === 'comment_new') {
            document.getElementById('no-comments')?.remove();
            renderNewComment(data);
            updateCount(1);
        } else if (data.event === 'comment_deleted') {
            if(data.deleted_ids) data.deleted_ids.forEach(id => removeCommentUI(id));
            else removeCommentUI(data.comment_id);
        } else if (data.event === 'reaction') {
            updatePostReactionUI(data.status === 'removed' ? null : data.reaction_type);
            document.getElementById('post-reaction-count').innerText = data.total_count;
        } else if (data.event === 'comment_reaction') {
            // Update realtime cho c√°c user kh√°c
            updateCommentReactionUI(data.comment_id, data.status === 'removed' ? null : data.reaction_type, data.count);
        }
    };

    function removeCommentUI(id) {
        const el = document.getElementById(`comment-${id}`);
        if(el) { el.remove(); updateCount(-1); }
    }

    function renderNewComment(data) {
        const indent = (data.level - 1) * 20;
        const threadLine = data.level > 1 ? '<div class="thread-line"></div>' : '';
        let mediaHtml = '';
        if(data.images) data.images.forEach(url => mediaHtml += `<img src="${url}" class="comment-img-preview">`);
        
        let reactionHtml = `
            <div class="comment-reaction-wrapper">
                <div class="comment-popup">
                    <span class="emoji-btn-small" onclick="submitCommentReaction(${data.comment_id}, 'like')">üëç</span>
                    <span class="emoji-btn-small" onclick="submitCommentReaction(${data.comment_id}, 'love')">‚ù§Ô∏è</span>
                    <span class="emoji-btn-small" onclick="submitCommentReaction(${data.comment_id}, 'haha')">üòÜ</span>
                    <span class="emoji-btn-small" onclick="submitCommentReaction(${data.comment_id}, 'wow')">üòÆ</span>
                    <span class="emoji-btn-small" onclick="submitCommentReaction(${data.comment_id}, 'sad')">üò¢</span>
                    <span class="emoji-btn-small" onclick="submitCommentReaction(${data.comment_id}, 'angry')">üò°</span>
                </div>
                <a href="#" onclick="submitCommentReaction(${data.comment_id}, 'like'); return false;" class="meta-action" id="btn-comment-txt-${data.comment_id}">Th√≠ch</a>
            </div>`;

        let actionsHtml = `<span>V·ª´a xong</span> ${reactionHtml} <a href="#" class="meta-action" onclick="showReplyForm(${data.comment_id}); return false;">Ph·∫£n h·ªìi</a>`;
        if(data.user === CURRENT_USER) actionsHtml += `<a href="#" class="meta-action delete" onclick="deleteComment(${data.comment_id}); return false;">X√≥a</a>`;

        const html = `
        <div class="comment-item fade-in" id="comment-${data.comment_id}" style="padding-left: ${indent}px;">
            <div class="d-flex position-relative w-100">
                ${threadLine}
                <img src="https://ui-avatars.com/api/?name=${data.user}" class="my-avatar" style="margin-right: 8px;">
                <div style="flex: 1;">
                    <div class="comment-bubble">
                        <a href="#" class="comment-author-name">${data.user}</a>
                        <div class="comment-text-content">${data.content}</div>
                        ${mediaHtml}
                        <div class="cmt-reaction-badge" id="comment-badge-${data.comment_id}" style="display: none !important;">
                            <i class="fas fa-thumbs-up"></i><span id="comment-count-${data.comment_id}">0</span>
                        </div>
                    </div>
                    <div class="comment-meta">${actionsHtml}</div>
                    <div id="reply-form-${data.comment_id}" class="mt-2 d-none fade-in">
                        <div class="d-flex align-items-center gap-2">
                             <img src="https://ui-avatars.com/api/?name=${CURRENT_USER}" class="my-avatar" style="width: 24px; height: 24px;">
                             <div class="input-bubble" style="padding: 4px 10px;">
                                <input type="text" id="reply-input-${data.comment_id}" placeholder="Tr·∫£ l·ªùi..." 
                                       onkeydown="if(event.key === 'Enter') submitComment({{ post.id }}, ${data.comment_id})">
                             </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;

        if (data.parent_id) {
            const parent = document.getElementById(`comment-${data.parent_id}`);
            if (parent) parent.insertAdjacentHTML('afterend', html);
        } else {
            document.getElementById('comments-list').insertAdjacentHTML('beforeend', html);
        }
    }

    function updateCount(delta) {
        const el = document.getElementById('total-comments-label');
        if(el) el.innerText = Math.max(0, parseInt(el.innerText) + delta);
    }

    // LIGHTBOX
    let currentImgIndex = 0;
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightbox-img');
    const lightboxCounter = document.getElementById('lightbox-counter');
    function openLightbox(index) { if(ALL_POST_IMAGES.length === 0) return; currentImgIndex = index; updateLightboxImage(); lightbox.classList.add('active'); document.body.style.overflow = 'hidden'; }
    function closeLightbox(e) { if(e) e.preventDefault(); lightbox.classList.remove('active'); document.body.style.overflow = 'auto'; }
    function changeImg(step, e) {
        if(e) e.stopPropagation();
        if (ALL_POST_IMAGES.length === 0) return;
        currentImgIndex += step;
        if (currentImgIndex >= ALL_POST_IMAGES.length) currentImgIndex = 0;
        else if (currentImgIndex < 0) currentImgIndex = ALL_POST_IMAGES.length - 1;
        updateLightboxImage();
    }
    function updateLightboxImage() { lightboxImg.style.opacity = 0; setTimeout(() => { lightboxImg.src = ALL_POST_IMAGES[currentImgIndex]; lightboxImg.style.opacity = 1; }, 150); lightboxCounter.innerText = `·∫¢nh ${currentImgIndex + 1} / ${ALL_POST_IMAGES.length}`; }
    document.addEventListener('keydown', e => { if(lightbox.classList.contains('active')) { if(e.key==="Escape") closeLightbox(); if(e.key==="ArrowLeft") changeImg(-1); if(e.key==="ArrowRight") changeImg(1); }});
    document.getElementById('comment-files').onchange = (e) => {
        const box = document.getElementById('main-preview'); box.innerHTML = '';
        Array.from(e.target.files).forEach(f => {
            const img = document.createElement('img'); img.src = URL.createObjectURL(f);
            img.style.height = '60px'; img.style.borderRadius = '8px'; img.style.marginRight = '5px'; box.appendChild(img);
        });
    }
</script>
{% endblock %}