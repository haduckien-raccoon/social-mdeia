{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    /* =========================================
       1. DESIGN SYSTEM (MODERN VARIABLES)
       ========================================= */
    :root {
        /* Colors */
        --primary: #1877f2;
        --primary-soft: rgba(24, 119, 242, 0.1);
        --bg-body: #f0f2f5;
        --bg-card: #ffffff;
        --text-main: #050505;
        --text-sub: #65676b;
        --divider: #e4e6eb;
        
        /* Interactive */
        --hover-bg: #f2f2f2;
        --hover-darker: #e4e6eb;
        
        /* Shadows & Radius */
        --shadow-card: 0 1px 2px rgba(0, 0, 0, 0.1), 0 4px 12px rgba(0,0,0,0.05);
        --shadow-float: 0 8px 24px rgba(0,0,0,0.15);
        --radius-card: 12px;
        --radius-btn: 8px;
        --radius-pill: 50px;
        
        /* Animations */
        --trans-fast: 0.2s cubic-bezier(0.2, 0, 0.4, 1);
    }

    body {
        background-color: var(--bg-body);
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        color: var(--text-main);
        -webkit-font-smoothing: antialiased;
    }

    .detail-container {
        max-width: 700px;
        margin: 24px auto;
        padding-bottom: 80px;
    }

    /* =========================================
       2. POST CARD & HEADER
       ========================================= */
    .fb-card {
        background: var(--bg-card);
        border-radius: var(--radius-card);
        box-shadow: var(--shadow-card);
        margin-bottom: 20px;
        overflow: hidden;
        transition: transform 0.2s;
    }

    /* Header */
    .post-header {
        padding: 16px;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .header-left { display: flex; align-items: center; gap: 12px; }
    
    .post-avatar {
        width: 44px; height: 44px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid rgba(0,0,0,0.1);
        cursor: pointer;
    }

    .post-info h4 {
        margin: 0; font-size: 15px; font-weight: 600; line-height: 1.2;
    }
    .post-info h4 a {
        text-decoration: none; color: var(--text-main);
        transition: color 0.2s;
    }
    .post-info h4 a:hover { text-decoration: underline; }

    .post-time {
        font-size: 13px; color: var(--text-sub);
        margin-top: 2px; display: flex; align-items: center; gap: 6px;
    }
    .post-time i { font-size: 11px; }

    /* Options Button */
    .btn-options {
        width: 36px; height: 36px;
        border-radius: 50%; border: none; background: transparent;
        color: var(--text-sub); cursor: pointer;
        display: flex; align-items: center; justify-content: center;
        transition: background var(--trans-fast);
    }
    .btn-options:hover { background-color: var(--hover-bg); color: var(--text-main); }

    /* Dropdown */
    .post-options-menu { position: relative; }
    .options-dropdown {
        position: absolute; top: 110%; right: 0;
        background: #fff; border-radius: 8px;
        box-shadow: var(--shadow-float);
        width: 240px; padding: 8px; z-index: 100;
        display: none; transform-origin: top right;
        animation: scaleIn 0.2s ease;
    }
    .options-dropdown.show { display: block; }
    .dropdown-item {
        display: flex; align-items: center; width: 100%;
        padding: 10px 12px; border: none; background: transparent;
        border-radius: 6px; cursor: pointer;
        font-size: 15px; font-weight: 500; color: var(--text-main);
        text-decoration: none; transition: background 0.1s;
    }
    .dropdown-item:hover { background-color: var(--hover-bg); }
    .dropdown-item i { width: 28px; font-size: 18px; color: var(--text-main); }
    .dropdown-item.danger { color: #dc3545; }
    .dropdown-item.danger i { color: #dc3545; }

    /* Content */
    .post-content {
        padding: 4px 16px 16px;
        font-size: 16px; line-height: 1.5;
        color: var(--text-main);
    }

    /* =========================================
       3. IMAGES & SHARED POST
       ========================================= */
    .post-images {
        display: grid; gap: 2px;
        background: #fff; cursor: pointer;
        overflow: hidden;
    }
    .img-wrapper { position: relative; width: 100%; height: 100%; overflow: hidden; }
    .img-wrapper img {
        width: 100%; height: 100%; object-fit: cover;
        transition: transform 0.3s ease;
    }
    .img-wrapper:hover img { transform: scale(1.05); }
    
    .grid-1 { grid-template-columns: 1fr; height: auto; max-height: 500px; }
    .grid-2 { grid-template-columns: 1fr 1fr; height: 380px; }
    .grid-3 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; height: 420px; }
    .grid-3 .img-wrapper:first-child { grid-row: span 2; }
    .grid-4 { grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; height: 420px; }

    .more-overlay {
        position: absolute; inset: 0; background: rgba(0,0,0,0.5);
        color: #fff; display: flex; justify-content: center; align-items: center;
        font-size: 32px; font-weight: 600; backdrop-filter: blur(2px);
    }

    /* Shared Post */
    .shared-post-container {
        margin: 0 16px 16px; border: 1px solid var(--divider);
        border-radius: 12px; overflow: hidden;
        transition: background 0.2s;
    }
    .shared-post-container:hover { background-color: #fcfcfc; }
    .shared-header { padding: 12px; display: flex; gap: 10px; align-items: center; border-bottom: 1px solid #f0f0f0; }
    .shared-avatar { width: 36px; height: 36px; border-radius: 50%; }
    .shared-info { font-weight: 600; font-size: 14px; }
    .shared-body { padding: 12px; font-size: 14px; }

    /* =========================================
       4. STATS & ACTIONS
       ========================================= */
    .post-stats {
        padding: 10px 16px;
        display: flex; justify-content: space-between;
        color: var(--text-sub); font-size: 14px;
        border-bottom: 1px solid var(--divider);
    }
    .reaction-count { display: flex; align-items: center; gap: 4px; }

    .post-actions {
        display: flex; padding: 4px 16px;
        border-bottom: 1px solid var(--divider);
    }
    .action-btn {
        flex: 1; display: flex; justify-content: center; align-items: center;
        height: 44px; border: none; background: transparent;
        color: var(--text-sub); font-weight: 600; font-size: 14px;
        border-radius: var(--radius-btn); gap: 8px; cursor: pointer;
        transition: background 0.2s, transform 0.1s;
    }
    .action-btn:hover { background-color: var(--hover-bg); }
    .action-btn:active { transform: scale(0.96); background-color: var(--hover-darker); }
    
    .action-btn i { font-size: 18px; }

    /* Reaction Popup */
    .reaction-wrapper { flex: 1; position: relative; }
    .reaction-wrapper .action-btn { width: 100%; }
    .reaction-popup {
        position: absolute; bottom: 100%; left: 10px;
        background: #fff; border-radius: 50px; padding: 6px 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        display: none; gap: 8px; z-index: 100;
        animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }
    .reaction-wrapper:hover .reaction-popup { display: flex; }
    .emoji-btn { font-size: 24px; cursor: pointer; transition: transform 0.2s; user-select: none; }
    .emoji-btn:hover { transform: scale(1.3) translateY(-4px); }

    /* Active Colors */
    .active-like, .text-like { color: var(--primary) !important; }
    .active-love, .text-love { color: #f33e58 !important; }
    .active-haha, .text-haha, .active-wow, .text-wow, .active-sad, .text-sad { color: #f7b125 !important; }
    .active-angry, .text-angry { color: #e9710f !important; }

    /* =========================================
       5. COMMENTS SECTION
       ========================================= */
    .comments-wrapper { padding: 12px 16px; background: #fff; }

    /* Input Area */
    .comment-input-area { display: flex; gap: 10px; margin-bottom: 20px; align-items: flex-start; }
    .my-avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; flex-shrink: 0; }
    
    .input-bubble {
        flex: 1; background: var(--bg-body);
        border-radius: 20px; padding: 8px 16px;
        display: flex; align-items: center;
        border: 1px solid transparent; transition: border 0.2s, background 0.2s;
    }
    .input-bubble:focus-within { background: #fff; border-color: var(--primary); }
    .input-bubble input {
        width: 100%; border: none; background: transparent;
        outline: none; font-size: 15px; padding: 4px 0;
    }
    .input-actions { display: flex; gap: 12px; color: var(--text-sub); align-items: center; }
    .input-actions i { cursor: pointer; transition: color 0.2s; font-size: 16px; }
    .input-actions i:hover { color: var(--primary); }

    /* Comment List */
    .comment-item { margin-bottom: 12px; position: relative; }
    .d-flex { display: flex; gap: 8px; }

    /* Thread Line */
    .thread-line {
        position: absolute; left: -14px; top: -10px;
        width: 24px; height: 45px;
        border-left: 2px solid #e4e6eb;
        border-bottom: 2px solid #e4e6eb;
        border-bottom-left-radius: 12px;
        pointer-events: none;
    }

    .comment-bubble {
        background: var(--bg-body);
        border-radius: 18px; padding: 8px 12px;
        display: inline-block; max-width: 100%; position: relative;
    }
    .comment-author-name {
        font-weight: 700; font-size: 13px; color: var(--text-main);
        text-decoration: none; display: block; margin-bottom: 2px;
    }
    .comment-text-content { font-size: 15px; line-height: 1.4; }

    .comment-meta {
        margin-left: 12px; margin-top: 4px;
        font-size: 12px; color: var(--text-sub);
        display: flex; gap: 12px; font-weight: 600;
    }
    .meta-action { cursor: pointer; text-decoration: none; color: var(--text-sub); transition: color 0.2s; }
    .meta-action:hover { text-decoration: underline; color: var(--text-main); }
    .meta-action.delete:hover { color: #dc3545; }

    /* Comment Reactions */
    .comment-reaction-wrapper { position: relative; }
    .comment-popup {
        position: absolute; bottom: 100%; left: -10px;
        background: #fff; border-radius: 50px; padding: 4px 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        display: none; gap: 4px; z-index: 50;
        animation: popUp 0.2s;
    }
    .comment-reaction-wrapper:hover .comment-popup { display: flex; }
    .emoji-btn-small { font-size: 20px; cursor: pointer; transition: transform 0.2s; }
    .emoji-btn-small:hover { transform: scale(1.4); }

    .cmt-reaction-badge {
        position: absolute; right: -6px; bottom: -8px;
        background: #fff; border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        padding: 2px 4px; display: flex; align-items: center; gap: 2px;
        font-size: 11px; z-index: 2;
    }

    /* =========================================
       6. MODALS & UTILS
       ========================================= */
    .modal-overlay {
        position: fixed; inset: 0;
        background: rgba(255,255,255,0.7);
        backdrop-filter: blur(8px);
        display: none; justify-content: center; align-items: center;
        z-index: 2000;
        animation: fadeIn 0.2s;
    }
    
    .modal-box {
        background: #fff; width: 100%; max-width: 520px;
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.2);
        border: 1px solid rgba(0,0,0,0.1);
        display: flex; flex-direction: column;
        animation: scaleIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
    }
    
    .modal-header {
        padding: 18px; border-bottom: 1px solid var(--divider);
        text-align: center; font-weight: 700; font-size: 20px;
        position: relative; color: var(--text-main);
    }
    .close-btn {
        position: absolute; right: 16px; top: 16px;
        width: 32px; height: 32px; border-radius: 50%;
        background: #e4e6eb; color: var(--text-sub);
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; font-size: 20px; transition: 0.2s;
    }
    .close-btn:hover { background: #d8dadf; }

    .modal-body { padding: 20px; }

    /* Custom Input Styles inside Modal */
    .share-caption, .custom-reason-area {
        width: 100%; border: 1px solid #ddd;
        border-radius: 8px; padding: 12px;
        font-family: inherit; resize: none; outline: none;
    }
    .share-caption:focus, .custom-reason-area:focus { border-color: var(--primary); }

    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 10px; }
    .btn-cancel {
        background: transparent; color: var(--primary);
        border: none; padding: 10px 20px; border-radius: 6px;
        font-weight: 600; cursor: pointer; transition: 0.2s;
    }
    .btn-cancel:hover { background: var(--primary-soft); }
    .btn-submit {
        background: #166fe5; color: #fff;
        border: none; padding: 10px 30px; border-radius: 6px;
        font-weight: 600; cursor: pointer; transition: 0.2s;
        box-shadow: 0 4px 12px rgba(24, 119, 242, 0.3);
    }
    .btn-submit:hover { background: #166fe5; transform: translateY(-1px); }

    /* Report Specific */
    .reason-item {
        display: flex; align-items: center; padding: 12px;
        border-radius: 8px; cursor: pointer; transition: 0.2s;
    }
    .reason-item:hover { background-color: #166fe5; color: #fff; }
    .reason-item input { margin-right: 14px; accent-color: var(--primary); width: 18px; height: 18px; }

    .lightbox { 
        position: fixed; 
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.95); 
        backdrop-filter: blur(5px); 
        z-index: 9999; /* ƒê·∫£m b·∫£o cao h∆°n t·∫•t c·∫£ c√°c th√†nh ph·∫ßn kh√°c */
        display: none; 
        justify-content: center; 
        align-items: center; 
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    
    .lightbox.show {
        display: flex;
        opacity: 1;
    }

    .lightbox-content {
        max-width: 90vw; 
        max-height: 90vh; 
        object-fit: contain; 
        box-shadow: 0 0 20px rgba(0,0,0,0.5);
        user-select: none;
    }

    .lightbox-nav { 
        position: absolute; 
        top: 50%; 
        transform: translateY(-50%);
        background: rgba(255,255,255,0.1); 
        color: #fff;
        border-radius: 50%; 
        width: 50px; height: 50px; 
        display: flex; align-items: center; justify-content: center; 
        cursor: pointer;
        font-size: 24px;
        transition: all 0.2s ease;
        z-index: 10000;
        user-select: none;
    }
    
    .lightbox-nav:hover { background: rgba(255,255,255,0.3); transform: translateY(-50%) scale(1.1); }
    .nav-prev { left: 30px; }
    .nav-next { right: 30px; }

    .lightbox-close {
        position: absolute; top: 20px; right: 30px; 
        color: rgba(255,255,255,0.7); 
        font-size: 40px; cursor: pointer; 
        z-index: 10001;
        transition: color 0.2s;
        line-height: 1;
    }
    .lightbox-close:hover { color: #fff; }
    
    #toast-notification {
        display: none;
        background-color: #333; color: #fff; border-radius: 8px;
        padding: 14px 24px; font-weight: 500;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    /* Animations */
    @keyframes popUp { from { opacity: 0; transform: translateY(10px) scale(0.8); } to { opacity: 1; transform: translateY(0) scale(1); } }
    @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    .fade-in { animation: fadeIn 0.4s ease; }
    .d-none { display: none !important; }
</style>
{% endblock %}

{% block content %}
<div class="detail-container">

    <div class="fb-card" id="post-{{ post.id }}">
        
        <div class="post-header">
            <div class="header-left">
                <img src="{{ post.author.profile.avatar.url|default:'images/avatars/normal.jpg' }}" class="post-avatar">
                <div class="post-info">
                    <h4><a href="#">{{ post.author.username }}</a></h4>
                    <div class="post-time">
                        <span>{{ post.created_at|timesince }} tr∆∞·ªõc</span> ‚Ä¢ 
                        {% if post.privacy == 'public' %}<i class="fas fa-globe-americas"></i>
                        {% elif post.privacy == 'friends' %}<i class="fas fa-user-friends"></i>
                        {% else %}<i class="fas fa-lock"></i>{% endif %}
                    </div>
                </div>
            </div>

            <div class="post-options-menu">
                <button class="btn-options" onclick="toggleDropdown('post-options-{{ post.id }}', event)">
                    <i class="fas fa-ellipsis"></i>
                </button>
                <div id="post-options-{{ post.id }}" class="options-dropdown">
                    {% if request.user == post.author %}
                        <a href="{% url 'posts:edit_post' post.id %}" class="dropdown-item">
                            <i class="fas fa-pen"></i> Ch·ªânh s·ª≠a
                        </a>
                        <button onclick="if(confirm('X√≥a b√†i vi·∫øt n√†y?')) document.getElementById('del-post').submit()" class="dropdown-item danger">
                            <i class="fas fa-trash"></i> X√≥a b√†i vi·∫øt
                        </button>
                        <form id="del-post" action="{% url 'posts:delete_post' post.id %}" method="POST" hidden>{% csrf_token %}</form>
                    {% else %}
                        <button onclick="openReportModal('post', {{ post.id }})" class="dropdown-item">
                            <i class="fas fa-flag"></i> B√°o c√°o b√†i vi·∫øt
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="post-content">{{ post.content|linebreaksbr }}</div>

        {% if original_post %}
        <div class="shared-post-container" onclick="window.location.href='{% url 'posts:post_detail' original_post.id %}'">
            <div class="shared-header">
                <img src="{{ original_post.author.profile.avatar.url|default:'images/avatars/normal.jpg' }}" class="shared-avatar">
                <div>
                    <div class="shared-info">{{ original_post.author.username }}</div>
                    <div class="shared-time" style="font-size: 12px; color: #65676b;">{{ original_post.created_at|timesince }} tr∆∞·ªõc</div>
                </div>
            </div>
            
            <div class="shared-body">
                <div style="margin-bottom: 12px;">{{ original_post.content|linebreaksbr }}</div>
                {% if original_post.images.all %}
                {% with total_imgs=original_post.images.count %}
                    <div class="post-images grid-{% if total_imgs >= 4 %}4{% else %}{{ total_imgs }}{% endif %}" onclick="event.stopPropagation()">
                        {% for img in original_post.images.all|slice:":4" %}
                            <div class="img-wrapper" onclick="openLightbox({{ forloop.counter0 }})">
                                <img src="{{ img.image.url }}">
                                {% if forloop.last and total_imgs > 4 %}
                                    <div class="more-overlay">+{{ total_imgs|add:"-3" }}</div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                {% endwith %}
                {% endif %}
            </div>
        </div>
        {% elif post.shared_post.exists and not original_post %}
            <div class="alert alert-warning" style="margin: 0 16px 16px; border-radius: 8px;">
                <i class="fas fa-exclamation-triangle"></i> N·ªôi dung n√†y hi·ªán kh√¥ng kh·∫£ d·ª•ng.
            </div>
        {% endif %}

        {% if post.images.all and not original_post %}
        {% with total_imgs=post.images.count %}
            <div class="post-images grid-{% if total_imgs >= 4 %}4{% else %}{{ total_imgs }}{% endif %}">
                {% for img in post.images.all|slice:":4" %}
                    <div class="img-wrapper" onclick="openLightbox({{ forloop.counter0 }})">
                        <img src="{{ img.image.url }}">
                        {% if forloop.last and total_imgs > 4 %}
                            <div class="more-overlay">+{{ total_imgs|add:"-3" }}</div>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        {% endwith %}
        {% endif %}

        <div class="post-stats">
            <div class="reaction-count">
                {% if total_reactions > 0 %}
                    <i class="fas fa-thumbs-up" style="background-color: #166fe5; color: #fff; border-radius: 50%; padding: 4px; font-size: 12px;"></i>
                    <span id="post-reaction-count" style="margin-left: 4px; color: var(--text-main); font-weight: 500;">{{ total_reactions }}</span>
                {% else %}
                    <span>Ch∆∞a c√≥ c·∫£m x√∫c n√†o</span>
                {% endif %}
            </div>
            <div class="comment-count"><span id="total-comments-label" style="color: var(--text-main); font-weight: 500;">{{ total_comments }}</span> b√¨nh lu·∫≠n</div>
        </div>

        <div class="post-actions">
            <div class="reaction-wrapper">
                <div class="reaction-popup">
                    {% comment %} <span class="emoji-btn" onclick="submitPostReaction('like')">üëç</span> {% endcomment %}
                    <span class="emoji-btn" onclick="submitPostReaction('like')"><i class="fas fa-thumbs-up" style="background-color: #166fe5; color: #fff; border-radius: 50%; padding: 4px; font-size: 18px;"></i></span>
                    {% comment %} <span class="emoji-btn" onclick="submitPostReaction('love')">‚ù§Ô∏è</span> {% endcomment %}
                    <span class="emoji-btn" onclick="submitPostReaction('love')"><i class="fas fa-heart" style="background-color: #f33e58; color: #fff; border-radius: 50%; padding: 4px; font-size: 18px;"></i></span>
                    <span class="emoji-btn" onclick="submitPostReaction('haha')">üòÜ</span>
                    {% comment %} <span class="emoji-btn" onclick="submitPostReaction('haha')"><i class="fas fa-laugh-squint" style="background-color: #f7b125; color: #fff; border-radius: 50%; padding: 4px; font-size: 18px;"></i></span> {% endcomment %}
                    <span class="emoji-btn" onclick="submitPostReaction('wow')">üòÆ</span>
                    {% comment %} <span class="emoji-btn" onclick="submitPostReaction('wow')"><i class="fas fa-surprise" style="background-color: #f7b125; color: #fff; border-radius: 50%; padding: 4px; font-size: 18px;"></i></span> {% endcomment %}
                    <span class="emoji-btn" onclick="submitPostReaction('sad')">üò¢</span>
                    {% comment %} <span class="emoji-btn" onclick="submitPostReaction('sad')"><i class="fas fa-sad-tear" style="background-color: #f7b125; color: #fff; border-radius: 50%; padding: 4px; font-size: 18px;"></i></span> {% endcomment %}
                    <span class="emoji-btn" onclick="submitPostReaction('angry')">üò°</span>
                    {% comment %} <span class="emoji-btn" onclick="submitPostReaction('angry')"><i class="fas fa-angry" style="background-color: #e9710f; color: #fff; border-radius: 50%; padding: 4px; font-size: 18px;"></i></span> {% endcomment %}
                </div>
                <button class="action-btn {% if post.current_user_reaction %}active-{{ post.current_user_reaction }}{% endif %}" 
                        id="main-like-btn" onclick="submitPostReaction('like')">
                    {% if post.current_user_reaction == 'like' %} <i class="fas fa-thumbs-up" style="background-color: #166fe5; color: #fff; border-radius: 50%; padding: 4px; font-size: 18px;"></i> Th√≠ch
                    {% elif post.current_user_reaction == 'love' %} <i class="fas fa-heart"></i> Y√™u th√≠ch
                    {% elif post.current_user_reaction == 'haha' %} <i class="fas fa-laugh-squint"></i> Haha
                    {% elif post.current_user_reaction == 'sad' %} <i class="fas fa-sad-tear"></i> Bu·ªìn
                    {% elif post.current_user_reaction == 'wow' %} <i class="fas fa-surprise"></i> Wow
                    {% elif post.current_user_reaction == 'angry' %} <i class="fas fa-angry"></i> Ph·∫´n n·ªô
                    {% else %} <i class="far fa-thumbs-up"></i> Th√≠ch
                    {% endif %}
                </button>
            </div>
            
            <button class="action-btn" onclick="document.getElementById('main-comment-input').focus()">
                <i class="far fa-comment-alt"></i> B√¨nh lu·∫≠n
            </button>
            
            <button class="action-btn" onclick="openShareModal()">
                <i class="fas fa-share"></i> Chia s·∫ª
            </button>
        </div>

        <div class="comments-wrapper">
            <div class="comment-input-area">
                <img src="{{ request.user.profile.avatar.url|default:'images/avatars/normal.jpg' }}" class="my-avatar">
                <div class="w-100">
                    <div class="input-bubble">
                        <input type="text" id="main-comment-input" placeholder="Vi·∫øt b√¨nh lu·∫≠n c√¥ng khai..." autocomplete="off" onkeydown="if(event.key === 'Enter') submitComment({{ post.id }})">
                        <div class="input-actions">
                            <label for="comment-files" style="margin:0; cursor: pointer; display: flex;"><i class="fas fa-camera"></i></label>
                            <i class="fas fa-paper-plane text-primary" onclick="submitComment({{ post.id }})"></i>
                        </div>
                        <input type="file" id="comment-files" hidden multiple accept="image/*">
                    </div>
                    <div id="main-preview" style="padding: 8px 0 0 10px;"></div>
                </div>
            </div>

            <div id="comments-list">
                {% for comment in comments %}
                    <div class="comment-item fade-in" id="comment-{{ comment.id }}" 
                         data-level="{{ comment.level }}" 
                         data-parent-id="{{ comment.parent_id|default:'' }}"
                         style="padding-left: {{ comment.index_px }}px;">
                         
                        <div class="d-flex position-relative w-100">
                            {% if comment.level > 1 %}<div class="thread-line"></div>{% endif %}
                            
                            <img src="https://ui-avatars.com/api/?name={{ comment.user.username }}&background=random" class="my-avatar" style="width: 32px; height: 32px;">
                            
                            <div style="flex: 1;">
                                <div class="comment-bubble">
                                    <a href="#" class="comment-author-name">{{ comment.user.username }}</a>
                                    <div class="comment-text-content">{{ comment.content }}</div>
                                    {% if comment.images.all %}
                                        {% for img in comment.images.all %}<img src="{{ img.image.url }}" class="comment-img-preview" style="max-height: 120px; display: block; margin-top: 8px; border-radius: 8px;">{% endfor %}
                                    {% endif %}
                                    
                                    <div class="cmt-reaction-badge" id="comment-badge-{{ comment.id }}" 
                                         style="display: {% if comment.likes_count > 0 %}flex{% else %}none{% endif %} !important;">
                                        <i class="fas fa-thumbs-up text-primary" style="font-size: 10px;"></i>
                                        <span id="comment-count-{{ comment.id }}" style="font-weight: 600;">{{ comment.likes_count }}</span>
                                    </div>
                                </div>
                                
                                <div class="comment-meta">
                                    <span>{{ comment.created_at|timesince }}</span>
                                    
                                    <div class="comment-reaction-wrapper">
                                        <div class="comment-popup">
                                            <span class="emoji-btn-small" onclick="submitCommentReaction({{ comment.id }}, 'like')">üëç</span>
                                            <span class="emoji-btn-small" onclick="submitCommentReaction({{ comment.id }}, 'love')">‚ù§Ô∏è</span>
                                            <span class="emoji-btn-small" onclick="submitCommentReaction({{ comment.id }}, 'haha')">üòÜ</span>
                                            <span class="emoji-btn-small" onclick="submitCommentReaction({{ comment.id }}, 'wow')">üòÆ</span>
                                            <span class="emoji-btn-small" onclick="submitCommentReaction({{ comment.id }}, 'sad')">üò¢</span>
                                            <span class="emoji-btn-small" onclick="submitCommentReaction({{ comment.id }}, 'angry')">üò°</span>
                                        </div>
                                        <a href="#" onclick="submitCommentReaction({{ comment.id }}, 'like'); return false;" 
                                           class="meta-action {% if comment.current_reaction %}text-{{ comment.current_reaction }}{% endif %}"
                                           id="btn-comment-txt-{{ comment.id }}">
                                           {% if comment.current_reaction == 'like' %}Th√≠ch
                                           {% elif comment.current_reaction == 'love' %}Y√™u th√≠ch
                                           {% elif comment.current_reaction == 'haha' %}Haha
                                           {% elif comment.current_reaction == 'wow' %}Wow
                                           {% elif comment.current_reaction == 'sad' %}Bu·ªìn
                                           {% elif comment.current_reaction == 'angry' %}Ph·∫´n n·ªô
                                           {% else %}Th√≠ch{% endif %}
                                        </a>
                                    </div>

                                    <a href="#" onclick="showReplyForm({{ comment.id }}); return false;" class="meta-action">Ph·∫£n h·ªìi</a>
                                    
                                    {% if request.user == comment.user or request.user == post.author %}
                                        <a href="#" onclick="deleteComment({{ comment.id }}); return false;" class="meta-action delete">X√≥a</a>
                                    {% else %}
                                        <a href="#" onclick="openReportModal('comment', {{ comment.id }}); return false;" class="meta-action">B√°o c√°o</a>
                                    {% endif %}
                                </div>

                                <div id="reply-form-{{ comment.id }}" class="mt-2 d-none fade-in" style="margin-top: 8px;">
                                    <div class="d-flex align-items-center gap-2">
                                         <img src="https://ui-avatars.com/api/?name={{ request.user.username }}" class="my-avatar" style="width: 24px; height: 24px;">
                                         <div class="input-bubble" style="padding: 4px 12px; min-height: 32px;">
                                            <input type="text" id="reply-input-{{ comment.id }}" placeholder="Vi·∫øt ph·∫£n h·ªìi..." 
                                                   style="font-size: 13px;"
                                                   onkeydown="if(event.key === 'Enter') submitComment({{ post.id }}, {{ comment.id }})">
                                         </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                {% empty %}
                    <div class="text-center p-4 text-muted" id="no-comments" style="font-size: 14px; color: var(--text-sub);">
                        H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n b√¨nh lu·∫≠n v·ªÅ b√†i vi·∫øt n√†y.
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<div id="toast-notification">Th√¥ng b√°o</div>

<div id="shareModal" class="modal-overlay" onclick="closeShareModal(event)">
    <div class="modal-box">
        <div class="modal-header">
            Chia s·∫ª b√†i vi·∫øt
            <span class="close-btn" onclick="closeShareModal()">&times;</span>
        </div>
        <form action="{% url 'posts:share_post' post.id %}" method="POST" class="modal-body">
            {% csrf_token %}
            <div class="share-user" style="display:flex; align-items:center; margin-bottom:15px; gap:10px;">
                <img src="{{ request.user.profile.avatar.url|default:'images/avatars/normal.jpg' }}" style="width:40px; height:40px; border-radius:50%;">
                <div>
                    <div style="font-weight: 600;">{{ request.user.username }}</div>
                    <select name="privacy" style="border:none; background:#f0f2f5; padding:2px 8px; border-radius:4px; font-size:12px; margin-top:2px; font-weight:600;">
                        <option value="public">üåç C√¥ng khai</option>
                        <option value="friends">üë• B·∫°n b√®</option>
                        <option value="only_me">üîí Ch·ªâ m√¨nh t√¥i</option>
                    </select>
                </div>
            </div>
            <textarea name="caption" class="share-caption" placeholder="H√£y n√≥i g√¨ ƒë√≥ v·ªÅ n·ªôi dung n√†y..." rows="3"></textarea>
            
            <div class="modal-actions">
                <button type="button" class="btn-cancel" onclick="closeShareModal()">H·ªßy</button>
                <button type="submit" class="btn-submit">Chia s·∫ª ngay</button>
            </div>
        </form>
    </div>
</div>

<div id="reportModal" class="modal-overlay" onclick="closeReportModal(event)">
    <div class="modal-box">
        <div class="modal-header">
            <span id="report-modal-title">B√°o c√°o vi ph·∫°m</span>
            <span class="close-btn" onclick="closeReportModal()">&times;</span>
        </div>
        <div class="modal-body">
            <p class="text-muted small mb-3" style="color:var(--text-sub); margin-bottom:12px;">Vui l√≤ng ch·ªçn v·∫•n ƒë·ªÅ b·∫°n ƒëang g·∫∑p ph·∫£i:</p>
            <form id="reportForm" onsubmit="submitReport(event)">
                <input type="hidden" id="report_target_type" name="target_type">
                <input type="hidden" id="report_target_id" name="target_id">

                <div class="report-reasons-list" style="display:flex; flex-direction:column; gap:4px;">
                    {% for reason in report_reasons %}
                    <label class="reason-item">
                        <input type="radio" name="reason" value="{{ reason.id }}" required onchange="toggleCustomReason(false)">
                        <span>{{ reason.name }}</span>
                    </label>
                    {% endfor %}
                    <label class="reason-item">
                        <input type="radio" name="reason" value="custom" onchange="toggleCustomReason(true)">
                        <span>V·∫•n ƒë·ªÅ kh√°c</span>
                    </label>
                </div>

                <textarea id="custom_reason_input" name="custom_reason" class="custom-reason-area" 
                          placeholder="M√¥ t·∫£ chi ti·∫øt vi ph·∫°m..." style="margin-top:15px; display:none;" rows="3"></textarea>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeReportModal()">H·ªßy</button>
                    <button type="submit" class="btn-submit">G·ª≠i</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="lightbox" class="lightbox" onclick="closeLightbox()">
    <span class="lightbox-close" onclick="closeLightbox()">&times;</span>
    
    <div class="lightbox-nav nav-prev" onclick="changeImg(-1, event)">
        <i class="fas fa-chevron-left"></i>
    </div>
    
    <div class="lightbox-nav nav-next" onclick="changeImg(1, event)">
        <i class="fas fa-chevron-right"></i>
    </div>
    
    <img id="lightbox-img" class="lightbox-content" src="" onclick="event.stopPropagation()">
</div>

<script>
    // --- GI·ªÆ NGUY√äN TO√ÄN B·ªò LOGIC JS C·ª¶A B·∫†N & LOGIC B√ÅO C√ÅO ƒê√É S·ª¨A ·ªû TR√äN ---
    const ALL_POST_IMAGES = [
        {% if original_post %}
            {% for img in original_post.images.all %}"{{ img.image.url }}",{% endfor %}
        {% else %}
            {% for img in post.images.all %}"{{ img.image.url }}",{% endfor %}
        {% endif %}
    ];
    const POST_ID = "{{ post.id }}";
    
    // CSRF Helper
    const getCookie = (name) => {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    };
    const csrftoken = getCookie('csrftoken');

    // UI Utils
    function showToast(message) {
        const toast = document.getElementById("toast-notification");
        toast.innerText = message;
        toast.style.visibility = "visible";
        toast.style.opacity = "1";
        toast.style.bottom = "50px";
        setTimeout(() => {
            toast.style.visibility = "hidden";
            toast.style.opacity = "0";
            toast.style.bottom = "30px";
        }, 3000);
    }

    function toggleDropdown(id, event) {
        event.stopPropagation();
        const dropdown = document.getElementById(id);
        document.querySelectorAll('.options-dropdown').forEach(d => {
            if (d.id !== id) d.classList.remove('show');
        });
        dropdown.classList.toggle('show');
    }
    document.addEventListener('click', () => {
        document.querySelectorAll('.options-dropdown').forEach(d => d.classList.remove('show'));
    });

    // Share Modal
    function openShareModal() {
        document.getElementById('shareModal').style.display = 'flex';
        document.querySelector('.share-caption').focus();
    }
    function closeShareModal(e) {
        const modal = document.getElementById('shareModal');
        if (!e || e.target === modal || e.target.classList.contains('close-btn') || e.target.classList.contains('btn-cancel')) {
            modal.style.display = 'none';
        }
    }

    // Report Modal & Logic (UPDATED)
    function openReportModal(targetType, targetId) {
        const modal = document.getElementById('reportModal');
        const titleSpan = document.getElementById('report-modal-title');
        
        document.getElementById('report_target_type').value = targetType;
        document.getElementById('report_target_id').value = targetId;
        document.getElementById('reportForm').reset();
        document.getElementById('custom_reason_input').style.display = 'none';

        if (targetType === 'comment') titleSpan.innerText = "B√°o c√°o b√¨nh lu·∫≠n";
        else titleSpan.innerText = "B√°o c√°o b√†i vi·∫øt";

        modal.style.display = 'flex';
    }

    function closeReportModal(e) {
        const modal = document.getElementById('reportModal');
        if (!e || e.target === modal || e.target.classList.contains('close-btn') || e.target.classList.contains('btn-cancel')) {
            modal.style.display = 'none';
        }
    }

    function toggleCustomReason(show) {
        const input = document.getElementById('custom_reason_input');
        input.style.display = show ? 'block' : 'none';
        if (show) input.focus();
    }

    function submitReport(e) {
        e.preventDefault();
        const targetType = document.getElementById('report_target_type').value;
        const targetId = document.getElementById('report_target_id').value;
        const reasonRadio = document.querySelector('input[name="reason"]:checked');
        const customReason = document.getElementById('custom_reason_input').value;

        if (!reasonRadio) return alert("Vui l√≤ng ch·ªçn l√Ω do b√°o c√°o.");

        let formData = new FormData();
        formData.append('target_type', targetType);
        formData.append('target_id', targetId);
        if (reasonRadio.value !== 'custom') formData.append('reason', reasonRadio.value);
        formData.append('custom_reason', customReason);

        fetch("{% url 'posts:report_post' %}", { 
            method: 'POST', headers: { 'X-CSRFToken': csrftoken }, body: formData
        }).then(res => res.json()).then(data => {
            if (data.success) {
                closeReportModal();
                showToast("ƒê√£ g·ª≠i b√°o c√°o th√†nh c√¥ng.");
            } else {
                alert("L·ªói: " + (data.error || "Kh√¥ng th·ªÉ g·ª≠i b√°o c√°o."));
            }
        });
    }

    // Reaction & Comments Logic (Gi·ªØ nguy√™n)
    function submitPostReaction(type) {
        fetch(`/posts/${POST_ID}/reaction/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `reaction=${type}`
        }).then(res => res.json()).then(data => {
            updateReactionUI(data.status === 'removed' ? null : type, data.total_count);
        });
    }

    function updateReactionUI(type, count) {
        const btn = document.getElementById('main-like-btn');
        btn.className = 'action-btn';
        if (!type) {
            btn.innerHTML = '<i class="far fa-thumbs-up"></i> Th√≠ch';
        } else {
            btn.classList.add(`active-${type}`);
            const map = { 'like':'Th√≠ch', 'love':'Y√™u th√≠ch', 'haha':'Haha', 'wow':'Wow', 'sad':'Bu·ªìn', 'angry':'Ph·∫´n n·ªô' };
            const icons = { 'like':'thumbs-up', 'love':'heart', 'haha':'laugh-squint', 'wow':'surprise', 'sad':'sad-tear', 'angry':'angry' };
            btn.innerHTML = `<i class="fas fa-${icons[type]}"></i> ${map[type]}`;
        }
        document.getElementById('post-reaction-count').innerText = count;
    }

    function submitCommentReaction(commentId, type) {
        fetch(`/posts/comment/${commentId}/reaction/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken, 'Content-Type': 'application/x-www-form-urlencoded' },
            body: `reaction=${type}`
        }).then(res => res.json()).then(data => {
            updateCommentReactionUI(commentId, data.status === 'removed' ? null : type, data.count);
        });
    }

    function updateCommentReactionUI(commentId, type, count) {
        const btn = document.getElementById(`btn-comment-txt-${commentId}`);
        if(btn) {
            btn.className = 'meta-action';
            const map = { 'like':'Th√≠ch', 'love':'Y√™u th√≠ch', 'haha':'Haha', 'wow':'Wow', 'sad':'Bu·ªìn', 'angry':'Ph·∫´n n·ªô' };
            if(!type) btn.innerText = 'Th√≠ch';
            else { btn.classList.add(`text-${type}`); btn.innerText = map[type]; }
        }
        const badge = document.getElementById(`comment-badge-${commentId}`);
        const cnt = document.getElementById(`comment-count-${commentId}`);
        if(cnt) cnt.innerText = count;
        if(badge) badge.style.display = count > 0 ? 'flex' : 'none';
    }

    window.submitComment = function(postId, parentId = null) {
        const inputId = parentId ? `reply-input-${parentId}` : 'main-comment-input';
        const input = document.getElementById(inputId);
        const content = input.value.trim();
        const fileInput = document.getElementById('comment-files');
        
        if (!content && (!fileInput || fileInput.files.length === 0)) return;
        
        let formData = new FormData();
        formData.append('content', content);
        if (parentId) formData.append('parent_id', parentId);
        if (!parentId && fileInput && fileInput.files.length > 0) {
            Array.from(fileInput.files).forEach(f => formData.append('images', f));
        }
        
        fetch(`/posts/${postId}/comment/`, {
            method: 'POST', headers: { 'X-CSRFToken': csrftoken }, body: formData
        }).then(res => res.json()).then(data => {
            if(data.status === 'ok') {
                input.value = '';
                if(parentId) document.getElementById(`reply-form-${parentId}`).classList.add('d-none');
                else { 
                    document.getElementById('main-preview').innerHTML = ''; 
                    fileInput.value = ''; 
                }
            }
        });
    };

    window.deleteComment = function(id) {
        if(confirm("X√≥a b√¨nh lu·∫≠n?")) fetch(`/posts/comment/${id}/delete/`, { method: 'POST', headers: { 'X-CSRFToken': csrftoken } });
    };

    window.showReplyForm = function(id) {
        document.querySelectorAll('[id^="reply-form-"]').forEach(el => el.classList.add('d-none'));
        const form = document.getElementById(`reply-form-${id}`);
        form.classList.remove('d-none');
        setTimeout(() => form.querySelector('input').focus(), 100);
    };
    
    document.getElementById('comment-files').onchange = (e) => {
        const box = document.getElementById('main-preview'); box.innerHTML = '';
        Array.from(e.target.files).forEach(f => {
            const img = document.createElement('img'); img.src = URL.createObjectURL(f);
            img.style.height = '60px'; img.style.borderRadius = '8px'; img.style.marginRight = '5px'; box.appendChild(img);
        });
    }

    // Websocket & Lightbox Logic (nh∆∞ c≈©)
    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const chatSocket = new WebSocket(wsScheme + '://' + window.location.host + '/ws/post/' + POST_ID + '/');
    chatSocket.onmessage = function(e) {
        const data = JSON.parse(e.data).data;
        if (data.event === 'comment_new') {
            document.getElementById('no-comments')?.remove();
            // H√†m renderNewComment n√™n ƒë∆∞·ª£c th√™m v√†o ƒë√¢y (nh∆∞ file c≈©) ƒë·ªÉ hi·ªÉn th·ªã comment m·ªõi
             window.location.reload(); // T·∫°m th·ªùi reload ƒë·ªÉ c·∫≠p nh·∫≠t UI m·ªõi nh·∫•t n·∫øu function render ph·ª©c t·∫°p
        } else if (data.event === 'comment_deleted') {
            window.location.reload(); 
        } else if (data.event === 'reaction' || data.event === 'comment_reaction') {
            // Logic update reaction kh√¥ng c·∫ßn reload
             if (data.event === 'reaction') updateReactionUI(data.status === 'removed' ? null : data.reaction_type, data.total_count);
             else updateCommentReactionUI(data.comment_id, data.status === 'removed' ? null : data.reaction_type, data.count);
        }
    };

    {% comment %} const ALL_POST_IMAGES = [
        {% if original_post %}
            {% for img in original_post.images.all %}"{{ img.image.url }}",{% endfor %}
            console.log("Original Post Images Loaded: ", ALL_POST_IMAGES);
        {% else %}
            {% for img in post.images.all %}"{{ img.image.url }}",{% endfor %}
        {% endif %}
    ]; {% endcomment %}

    let currentImgIndex = 0;
    const lightbox = document.getElementById('lightbox');
    const lightboxImg = document.getElementById('lightbox-img');

    // M·ªü Lightbox
    function openLightbox(index) { 
        if(ALL_POST_IMAGES.length === 0) return; 
        currentImgIndex = index; 
        updateLightboxImage(); 
        
        lightbox.classList.add('show'); // D√πng class ƒë·ªÉ k√≠ch ho·∫°t CSS flex/opacity
        document.body.style.overflow = 'hidden'; // Ch·∫∑n cu·ªôn trang web
    }

    // ƒê√≥ng Lightbox
    function closeLightbox(e) { 
        // N·∫øu event ƒë∆∞·ª£c truy·ªÅn v√†o (t·ª´ click), ƒë·∫£m b·∫£o kh√¥ng ƒë√≥ng khi click v√†o ·∫£nh/n√∫t
        if (e && e.target !== lightbox && !e.target.classList.contains('lightbox-close')) return;
        
        lightbox.classList.remove('show'); 
        document.body.style.overflow = 'auto'; // Cho ph√©p cu·ªôn l·∫°i
    }

    // Chuy·ªÉn ·∫£nh
    function changeImg(step, e) {
        if(e) e.stopPropagation(); // NgƒÉn s·ª± ki·ªán click lan ra ngo√†i l√†m ƒë√≥ng lightbox
        
        currentImgIndex += step;
        
        // Logic v√≤ng l·∫∑p (Cu·ªëi v·ªÅ ƒë·∫ßu, ƒê·∫ßu v·ªÅ cu·ªëi)
        if (currentImgIndex >= ALL_POST_IMAGES.length) {
            currentImgIndex = 0;
        } else if (currentImgIndex < 0) {
            currentImgIndex = ALL_POST_IMAGES.length - 1;
        }
        
        updateLightboxImage();
    }

    // C·∫≠p nh·∫≠t src cho ·∫£nh
    function updateLightboxImage() { 
        lightboxImg.style.opacity = '0.5'; // Hi·ªáu ·ª©ng m·ªù nh·∫π khi chuy·ªÉn
        lightboxImg.src = ALL_POST_IMAGES[currentImgIndex];
        setTimeout(() => lightboxImg.style.opacity = '1', 150);
    }

    // B·∫Øt s·ª± ki·ªán b√†n ph√≠m (M≈©i t√™n & ESC)
    document.addEventListener('keydown', function(e) { 
        if (lightbox.classList.contains('show')) { 
            if(e.key === "Escape") closeLightbox(); 
            if(e.key === "ArrowLeft") changeImg(-1); 
            if(e.key === "ArrowRight") changeImg(1); 
        }
    });
</script>
{% endblock %}