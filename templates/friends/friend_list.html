{% load friend_extras %}
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Friends</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
body { background: #f0f2f5; padding: 20px; }
.container { max-width: 1000px; margin: 0 auto; }
.section { background: #fff; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
.section-title { font-size: 20px; font-weight: 600; color: #333; margin-bottom: 15px; border-bottom: 2px solid #f0f2f5; padding-bottom: 10px; }
.user-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 15px; }
.user-card { border: 1px solid #e0e2e5; border-radius: 10px; padding: 15px; display: flex; align-items: center; justify-content: space-between; background: #fff; }
.user-info { display: flex; align-items: center; gap: 10px; }
.avatar-placeholder { width: 40px; height: 40px; background: #6a5af9; color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; }
.actions { display: flex; gap: 5px; }
.btn { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; color: #fff; text-decoration: none; transition: 0.3s; }
.btn-accept { background: #2ecc71; }
.btn-accept:hover { background: #27ae60; }
.btn-reject { background: #e74c3c; }
.btn-reject:hover { background: #c0392b; }
.btn-unfriend { background: #ff9f43; }
.btn-unfriend:hover { background: #e67e22; }
.btn-send { background: #6a5af9; }
.btn-send:hover { background: #5846e0; }
.btn-pending { background: #95a5a6; cursor: not-allowed; }
.empty-msg { color: #888; font-style: italic; }
.alert { padding: 10px; border-radius: 8px; margin-bottom: 15px; color: #fff; text-align: center; }
.alert-success { background: #2ecc71; }
.alert-error { background: #e74c3c; }
.alert-info { background: #3498db; }
.alert-warning { background: #ff9f43; }
form { display: inline-block; margin: 0; }
</style>
</head>
<body>

<div class="container">
    {% for message in messages %}
        <div class="alert {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-error{% elif message.tags == 'info' %}alert-info{% elif message.tags == 'warning' %}alert-warning{% endif %}">
            {{ message }}
        </div>
    {% endfor %}

    <!-- Pending Requests -->
    <div class="section">
        <h2 class="section-title"><i class="fa-solid fa-user-clock"></i> Friend Requests</h2>
        <div class="user-list">
            {% for req in pending_requests %}
            {% get_friend_ship user req.from_user as status %}
            <div class="user-card">
                <div class="user-info">
                    <div class="avatar-placeholder">{{ req.from_user.username|first|upper }}</div>
                    <div>
                        <strong>{{ req.from_user.username }}</strong><br>
                        <small>{{ req.from_user.email }}</small>
                    </div>
                </div>
                <div class="actions">
                    {% if req.from_user.id != user.id %}
                        <form action="{% url 'friends:accept_request' req.id %}" method="POST">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-accept"><i class="fa-solid fa-check"></i></button>
                        </form>
                        <form action="{% url 'friends:reject_request' req.id %}" method="POST">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-reject"><i class="fa-solid fa-xmark"></i></button>
                        </form>
                    {% else %}
                        <form action="{% url 'friends:cancel_request' req.id %}" method="POST">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-reject"><i class="fa-solid fa-ban"></i> Cancel</button>
                        </form>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <p class="empty-msg">No pending requests.</p>
            {% endfor %}
        </div>
    </div>

    <!-- Suggestions -->
    <div class="section">
        <h2 class="section-title"><i class="fa-solid fa-wand-magic-sparkles"></i> People You May Know</h2>
        <div class="user-list">
            {% for s in suggestions %}
            {% get_friend_ship user s as status %}
            <div class="user-card">
                <div class="user-info">
                    <div class="avatar-placeholder" style="background: #ff9f43">{{ s.username|first|upper }}</div>
                    <div>
                        <strong>{{ s.username }}</strong><br>
                        <small>Suggested</small>
                    </div>
                </div>
                <div class="actions">
                    {% if status == "none" or status == "rejected" %}
                        <form action="{% url 'friends:send_request' s.id %}" method="POST">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-send">Add Friend</button>
                        </form>
                    {% elif status == "pending" %}
                        <button class="btn btn-pending" disabled>Pending</button>
                    {% elif status == "accepted" %}
                        <button class="btn btn-unfriend" disabled>Friend</button>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <p class="empty-msg">No suggestions available.</p>
            {% endfor %}
        </div>
    </div>

    <!-- Friends -->
    <div class="section">
        <h2 class="section-title"><i class="fa-solid fa-users"></i> My Friends ({{ friends|length }})</h2>
        <div class="user-list">
            {% for f in friends %}
            <div class="user-card">
                <div class="user-info">
                    <div class="avatar-placeholder" style="background: #2ecc71">{{ f.username|first|upper }}</div>
                    <div>
                        <strong>{{ f.username }}</strong><br>
                        <small>{{ f.email }}</small>
                    </div>
                </div>
                <div class="actions">
                    <form action="{% url 'friends:unfriend' f.id %}" method="POST" onsubmit="return confirm('Are you sure?');">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-unfriend">Unfriend</button>
                    </form>
                </div>
            </div>
            {% empty %}
            <p class="empty-msg">You have no friends yet.</p>
            {% endfor %}
        </div>
    </div>

</div>

</body>
</html>
