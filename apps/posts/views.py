from django.shortcuts import render, redirect, get_object_or_404
from django.http import JsonResponse, HttpResponseForbidden
from django.contrib.auth.decorators import login_required
from django.views.decorators.http import require_POST
from django.db.models import Count, Q
from apps.posts.models import *
from apps.posts.services import *
from apps.friends.models import Friend
# =====================================================
# FEED VIEWS
# =====================================================
from django.shortcuts import render
from django.db.models import Q, Count
from .models import Post, PostReaction


def feed_view(request):
    """
    Bảng tin cá nhân (Giống Facebook)
    - Tối ưu query
    - Tránh N+1 cho Reaction, Profile, Shared Post
    """

    # 1. Lấy danh sách ID bạn bè
    friends_ids = get_friend_ids(request.user)

    # 2. Query cơ bản (lọc quyền riêng tư)
    posts = (
        Post.objects
        .filter(is_deleted=False)
        .filter(
            Q(privacy="public") |
            Q(privacy="friends", author__id__in=friends_ids) |
            Q(privacy="only_me", author=request.user)
        )
        .order_by("-created_at")
    )

    # 3. Eager loading (FIX ĐÚNG FIELD)
    posts = (
        posts
        .select_related(
            "author",                # User
            "author__profile",       # Profile của User
        )
        .prefetch_related(
            "images",                                   # Ảnh bài viết
            "files",                                    # File đính kèm
            "comments",                                 # Comment preview
            "shared_post",                              # PostShare (reverse)
            "shared_post__original_post",               # Bài gốc
            "shared_post__original_post__author",
            "shared_post__original_post__author__profile",
            "shared_post__original_post__images",
        )
    )

    # 4. Annotate đếm reaction & comment
    posts = posts.annotate(
        reaction_count=Count("reactions", distinct=True),
        comment_count=Count(
            "comments",
            filter=Q(comments__is_deleted=False),
            distinct=True
        )
    )

    # 5. Thực thi SQL (1 QUERY)
    post_list = list(posts)

    # 6. Lấy reaction của user hiện tại (1 QUERY)
    if request.user.is_authenticated and post_list:
        my_reactions = (
            PostReaction.objects
            .filter(user=request.user, post__in=post_list)
            .values_list("post_id", "reaction_type")
        )
        my_reaction_map = {pid: rtype for pid, rtype in my_reactions}
    else:
        my_reaction_map = {}

    # 7. Gán dữ liệu cho template (KHÔNG QUERY THÊM)
    for post in post_list:
        # Reaction của user hiện tại
        post.current_user_reaction = my_reaction_map.get(post.id)

        # Xử lý bài share (đã prefetch)
        shares = list(post.shared_post.all())
        if shares:
            post.original_post_obj = shares[0].original_post
        else:
            post.original_post_obj = None

    # 8. Context
    context = {
        "posts": post_list,
        "profile": getattr(request.user, "profile", None),
    }

    return render(request, "posts/feed.html", context)


def public_feed_view(request):
    """Bảng tin công khai"""
    posts = get_public_feed()
    posts = posts.annotate(
        reaction_count=Count('reactions', distinct=True),
        comment_count=Count('comments', filter=Q(comments__is_deleted=False), distinct=True)
    )
    for post in posts:
        reaction = PostReaction.objects.filter(post=post, user=request.user).first()
        post.current_user_reaction = reaction.reaction_type if reaction else None
    return render(request, "posts/public_feed.html", {"posts": posts})

# apps/posts/views.py

def post_detail_view(request, post_id):
    """Chi tiết bài viết - Fix logic hiển thị Comment Tree"""
    post = get_object_or_404(
        Post.objects.select_related("author").prefetch_related(
            "images", "files", "tagged_users", "hashtags", "reactions"
        ),
        id=post_id,
        is_deleted=False
    )

    # 1. Privacy Check
    if post.privacy == "only_me" and post.author != request.user:
        return HttpResponseForbidden("Bài viết riêng tư")
    if post.privacy == "friends":
        is_friend = Friend.objects.filter(
            Q(user=post.author, friend=request.user) | 
            Q(user=request.user, friend=post.author)
        ).exists()
        if not is_friend and post.author != request.user:
            return HttpResponseForbidden("Chỉ bạn bè mới xem được")

    # 2. Get All Comments (Chưa sắp xếp thứ tự hiển thị, chỉ sắp xếp thời gian để xử lý logic)
    raw_comments = (
        Comment.objects
        .filter(post=post, is_deleted=False)
        .select_related("user")
        .prefetch_related("images", "files")
        .annotate(likes_count=Count('reactions'))
        .order_by("created_at") # Order by time để đảm bảo con sinh sau nằm dưới con sinh trước
    )

    # --- LOGIC SẮP XẾP CÂY (FLATTEN TREE) ---
    # Mục tiêu: Biến danh sách phẳng lộn xộn thành danh sách: [Cha A, Con A1, Con A1a, Cha B, ...]
    
    # B1: Gom nhóm comment theo parent_id
    from collections import defaultdict
    children_map = defaultdict(list)
    root_comments = []
    
    # Map để lấy reaction của user hiện tại (Tối ưu query)
    comment_reactions = CommentReaction.objects.filter(
        comment__post=post, user=request.user
    ).values_list('comment_id', 'reaction_type')
    my_reaction_map = {c_id: r_type for c_id, r_type in comment_reactions}

    for c in raw_comments:
        # Xử lý data phụ trợ luôn trong vòng lặp này
        c.current_reaction = my_reaction_map.get(c.id)
        c.index_px = max(0, (c.level - 1) * 20) # Tính padding

        if c.parent_id:
            children_map[c.parent_id].append(c)
        else:
            root_comments.append(c)

    # B2: Hàm đệ quy để tạo danh sách phẳng
    sorted_comments = []
    def recursive_add(comment):
        sorted_comments.append(comment)
        # Tìm các con của comment này
        children = children_map.get(comment.id, [])
        for child in children:
            recursive_add(child)

    # B3: Duyệt qua các comment gốc
    for root in root_comments:
        recursive_add(root)
    
    # ----------------------------------------

    # 4. Post Reaction của User hiện tại
    post_reaction = PostReaction.objects.filter(post=post, user=request.user).first()
    post.current_user_reaction = post_reaction.reaction_type if post_reaction else None

    # Reaction Breakdown
    reaction_counts = PostReaction.objects.filter(post=post).values('reaction_type').annotate(count=Count('id'))
    reaction_breakdown = {item['reaction_type']: item['count'] for item in reaction_counts}

    count_comment = get_comment_count(post)

    report_reaseons = ReportReason.objects.all()

    #lấy bài viết gốc của bài viết được chia sẻ (nếu có)
    original_post = None
    share_info = post.shared_post.select_related(
        "original_post",
        "original_post__author"
    ).prefetch_related(
        "original_post__images",
        "original_post__files",
        "original_post__tagged_users",
        "original_post__hashtags",
    ).first()
    if share_info:
        original_post = share_info.original_post
    else:
        original_post = None

    #in ra log để debug
    print(f"[DEBUG] Original Post: {original_post}")
    context = {
        "post": post,
        "original_post": original_post,
        "comments": sorted_comments, # TRUYỀN DANH SÁCH ĐÃ SẮP XẾP
        "reaction_breakdown": reaction_breakdown,
        "total_reactions": PostReaction.objects.filter(post=post).count(),
        "total_comments": len(sorted_comments),
        "count_comment": count_comment,
        "report_reasons": report_reaseons,
    }

    return render(request, "posts/post_detail.html", context)

# =====================================================
# POST CRUD
# =====================================================
def create_post_view(request):
    """Tạo bài viết mới"""
    if request.method == "POST":
        content = request.POST.get("content", "")
        privacy = request.POST.get("privacy", "public")

        images = request.FILES.getlist("images")
        #in ra log để debug
        print(f"[DEBUG] Uploaded images: {images}")
        files = request.FILES.getlist("files")
        tagged = request.POST.getlist("tagged_users")
        location = request.POST.get("location", "")

        post = create_post(
            user=request.user,
            content=content,
            privacy=privacy,
            images=images,
            files=files,
            tagged_users=tagged,
            location_name=location
        )

        return redirect("posts:post_detail", post_id=post.id)
    
    # GET request - Show form
    friends = list_people_tag(request.user)
    profile = request.user.profile
    return render(request, "posts/create_post.html", {"friends": friends, "profile": profile})

def edit_post_view(request, post_id):
    """Chỉnh sửa bài viết"""
    post = get_object_or_404(Post, id=post_id, is_deleted=False)

    if post.author != request.user:
        return HttpResponseForbidden()

    if request.method == "POST":
        content = request.POST.get("content")
        privacy = request.POST.get("privacy")
        tag_users = request.POST.getlist("tagged_users")
        print(f"[DEBUG] Tagged Users: {tag_users}")
        location = request.POST.get("location", "")
        
        # 1. Lấy file MỚI upload lên
        images = request.FILES.getlist("images")
        files = request.FILES.getlist("files")
        
        # 2. Lấy danh sách ID CŨ cần xóa (quan trọng)
        delete_image_ids = request.POST.getlist("delete_image_ids")
        delete_file_ids = request.POST.getlist("delete_file_ids")

        print(f"[DEBUG] New Images: {images}")
        print(f"[DEBUG] Delete Img IDs: {delete_image_ids}")

        update_post(
            post, 
            content=content, 
            privacy=privacy, 
            tagged_users=tag_users, 
            images=images, 
            files=files, 
            location_name=location,
            delete_image_ids=delete_image_ids, # Truyền vào service
            delete_file_ids=delete_file_ids    # Truyền vào service
        )
        return redirect("posts:post_detail", post_id=post.id)
    
    friends = list_people_tag(request.user)
    profile = request.user.profile
    return render(request, "posts/edit_post.html", {"post": post, "friends": friends, "profile": profile})

@require_POST
def delete_post_view(request, post_id):
    """Xóa bài viết"""
    post = get_object_or_404(Post, id=post_id)
    delete_post(request.user, post)
    return redirect("posts:feed")

# =====================================================
# COMMENT CRUD (AJAX/REALTIME)
# =====================================================
@require_POST
def create_comment_view(request, post_id):
    """Tạo bình luận mới - Trả về JSON cho AJAX"""
    post = get_object_or_404(Post, id=post_id, is_deleted=False)
    
    content = request.POST.get("content", "").strip()
    if not content:
        return JsonResponse({"error": "Content is required"}, status=400)
    
    parent_id = request.POST.get("parent_id")
    parent = Comment.objects.filter(id=parent_id).first() if parent_id else None

    images = request.FILES.getlist("images")
    files = request.FILES.getlist("files")

    try:
        comment = create_comment(
            user=request.user,
            post=post,
            content=content,
            parent=parent,
            images=images,
            files=files
        )
        
        return JsonResponse({
            "status": "ok",
            "comment_id": comment.id,
            "message": "Comment created successfully"
        })
    except ValidationError as e:
        return JsonResponse({"error": str(e)}, status=400)

@require_POST
def edit_comment_view(request, comment_id):
    """Chỉnh sửa bình luận"""
    comment = get_object_or_404(Comment, id=comment_id, is_deleted=False)
    content = request.POST.get("content", "").strip()
    
    if not content:
        return JsonResponse({"error": "Content is required"}, status=400)
    
    try:
        update_comment(request.user, comment, content)
        return JsonResponse({"status": "ok"})
    except PermissionDenied as e:
        return JsonResponse({"error": str(e)}, status=403)

@require_POST
def delete_comment_view(request, comment_id):
    """Xóa bình luận"""
    comment = get_object_or_404(Comment, id=comment_id)
    
    try:
        delete_comment(request.user, comment)
        return JsonResponse({"status": "ok"})
    except PermissionDenied as e:
        return JsonResponse({"error": str(e)}, status=403)

# =====================================================
# REACTION VIEWS (AJAX/REALTIME)
# =====================================================
@require_POST
def toggle_post_reaction_view(request, post_id):
    """Toggle reaction cho bài viết"""
    post = get_object_or_404(Post, id=post_id)
    reaction_type = request.POST.get("reaction", "like")
    
    result = toggle_post_reaction(request.user, post, reaction_type)
    return JsonResponse(result)

@require_POST
def toggle_comment_reaction_view(request, comment_id):
    """Toggle reaction cho bình luận"""
    comment = get_object_or_404(Comment, id=comment_id)
    reaction_type = request.POST.get("reaction", "like")
    
    result = toggle_comment_reaction(request.user, comment, reaction_type)
    return JsonResponse(result)

# =====================================================
# OTHER ACTIONS
# =====================================================
@require_POST
def share_post_view(request, post_id):
    """Chia sẻ bài viết"""
    original_post = get_object_or_404(Post, id=post_id)
    caption = request.POST.get("caption", "")
    privacy = request.POST.get("privacy", "public")

    new_post = share_post(request.user, original_post, caption, privacy)
    return redirect("posts:post_detail", post_id=new_post.id)

@require_POST
def report_view(request):
    """Báo cáo bài viết hoặc bình luận"""
    target_type = request.POST.get("target_type")
    target_id = request.POST.get("target_id")
    reason_id = request.POST.get("reason")
    custom_reason = request.POST.get("custom_reason", "")
    reporter = request.user

    #in ra log để debug
    print(f"[DEBUG] Report - Type: {target_type}, ID: {target_id}, Reason: {reason_id}, Custom: {custom_reason}, Reporter: {reporter}")

    report_target(
        user=reporter,
        target_type=target_type,
        target_id=target_id,
        reason_id=reason_id,
        custom_reason=custom_reason
    )
    return JsonResponse({"success": True})

@require_POST
def toggle_commenting_view(request, post_id):
    """Bật/tắt bình luận cho bài viết"""
    post = get_object_or_404(Post, id=post_id)
    enable = request.POST.get("enable") == "true"
    
    try:
        toggle_comments(post, request.user, enable)
        return JsonResponse({"success": True})
    except PermissionDenied as e:
        return JsonResponse({"error": str(e)}, status=403)

@require_POST
def toggle_hide_counts_view(request, post_id):
    """Ẩn/hiện số lượng reactions và comments"""
    post = get_object_or_404(Post, id=post_id)
    hide_comment = request.POST.get("hide_comment")
    hide_reaction = request.POST.get("hide_reaction")

    try:
        toggle_hide_counts(
            post,
            request.user,
            hide_comment=hide_comment == "true" if hide_comment else None,
            hide_reaction=hide_reaction == "true" if hide_reaction else None,
        )
        return JsonResponse({"success": True})
    except PermissionDenied as e:
        return JsonResponse({"error": str(e)}, status=403)